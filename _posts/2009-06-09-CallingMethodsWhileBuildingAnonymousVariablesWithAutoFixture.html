---
layout: post
tags: [AutoFixture]
date: 2009-06-09 17:50:54 UTC
title: "Calling Methods While Building Anonymous Variables With AutoFixture"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p>Previously, we saw how you can <a href="http://blog.ploeh.dk/2009/06/01/SettingPropertyValuesWhileBuildingAnonymousVariablesWithAutoFixture.aspx">set property values while building</a> <a href="http://blogs.msdn.com/ploeh/archive/2008/11/17/anonymous-variables.aspx">anonymous variables</a> with <a href="http://autofixture.codeplex.com/">AutoFixture</a>. While I insinuated that I consider this a somewhat atypical scenario, we can now safely venture forth to the truly exotic :)</p> <p>Imagine that you want to build an anonymous instance of a type that requires you to call a certain method before you can start assigning properties. It's difficult to come up with a reasonable example of this, but although I consider it quite bad design, I've seen interfaces that include an Initialize method that must be called before any other member. In our example, let's call this interface IBadDesign.</p> <p>Let's say that we have a class called SomeImp that implements IBadDesign. Here's the relevant part of the class:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 \cf1 #region\cf0  IBadDesign Members\par ??\par ??\cf1 public\cf0  \cf1 string\cf0  Message\par ??\{\par ??    \cf1 get\cf0  \{ \cf1 return\cf0  \cf1 this\cf0 .message; \}\par ??    \cf1 set\par ??\cf0     \{\par ??        \cf1 if\cf0  (\cf1 this\cf0 .mc == \cf1 null\cf0 )\par ??        \{\par ??            \cf1 throw\cf0  \cf1 new\cf0  \cf4 InvalidOperationException\cf0 (\cf5 "..."\cf0 );\par ??        \}\par ??\par ??        \cf1 this\cf0 .message = \cf1 value\cf0 ;\par ??        \cf1 this\cf0 .transformedMessage = \cf1 this\cf0 .mc.DoStuff(\cf1 value\cf0 );\par ??    \}\par ??\}\par ??\par ??\cf1 public\cf0  \cf1 void\cf0  Initialize(\cf4 MyClass\cf0  mc)\par ??\{\par ??    \cf1 this\cf0 .mc = mc;\par ??\}\par ??\par ??\cf1 #endregion}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">#region</span> IBadDesign Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">string</span> Message</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span> { <span style="color: blue">return</span> <span style="color: blue">this</span>.message; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">set</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">this</span>.mc == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">"..."</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.message = <span style="color: blue">value</span>;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.transformedMessage = <span style="color: blue">this</span>.mc.DoStuff(<span style="color: blue">value</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> Initialize(<span style="color: #2b91af">MyClass</span> mc)</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.mc = mc;</pre><pre style="margin: 0px">}</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">#endregion</span></pre></div>
<p>This is a rather ridiculous example, but I couldn't think of a better one. The main point here is that given a brand-new instance of SomeImp, this usage is invalid:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red163\green21\blue21;}??\fs20 something.Message = \cf3 "Ploeh"\cf0 ;}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">something.Message = <span style="color: #a31515">"Ploeh"</span>;</pre></div>
<p>While the above code snippet will throw an InvalidOperationException, this will work:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red0\green0\blue255;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 something.Initialize(\cf3 new\cf0  \cf4 MyClass\cf0 ());\par ??something.Message = \cf5 "Ploeh"\cf0 ;}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">something.Initialize(<span style="color: blue">new</span> <span style="color: #2b91af">MyClass</span>());</pre><pre style="margin: 0px">something.Message = <span style="color: #a31515">"Ploeh"</span>;</pre></div>
<p>The problem is that by default, AutoFixture ignores methods and only assigns properties, which means that this is also going to throw:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 var\cf0  imp = fixture.CreateAnonymous&lt;\cf4 SomeImp\cf0 &gt;();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> imp = fixture.CreateAnonymous&lt;<span style="color: #2b91af">SomeImp</span>&gt;();</pre></div>
<p>As we saw with properties, we can use the Build method to customize how the type is being created. Properties can be set with the With method, while methods can be invoked with the Do method, so this is all it takes:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 var\cf0  imp = fixture.Build&lt;\cf4 SomeImp\cf0 &gt;()\par ??    .Do(s =&gt; s.Initialize(\cf1 new\cf0  \cf4 MyClass\cf0 ()))\par ??    .CreateAnonymous();    }
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> imp = fixture.Build&lt;<span style="color: #2b91af">SomeImp</span>&gt;()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .Do(s =&gt; s.Initialize(<span style="color: blue">new</span> <span style="color: #2b91af">MyClass</span>()))</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .CreateAnonymous();&nbsp;&nbsp;&nbsp; </pre></div>
<p>We don't have to explicitly set the Message property, as AutoFixture is going to do this automatically, and all implicit assignments happen after explicit actions defined by With or Do (and in case you were wondering, you can mix With and Do, and ObjectBuilder&lt;T&gt; will preserve the ordering).</p>
<p>In most cases, having to use the Do method probably constitutes a design smell of the <a href="http://xunitpatterns.com/SUT.html">SUT</a>, but the method is there if you need it.</p>
</div>
	