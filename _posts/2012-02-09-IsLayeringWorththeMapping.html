---
layout: post
tags: [Dependency Injection, Software Design]
date: 2012-02-09 22:55:44 UTC
title: "Is Layering Worth the Mapping?"
---
{% include JB/setup %}

<div id="post">
	<p>For years, layered application architecture has been a de-facto standard for loosely coupled architectures, but the question is: does the layering really provide benefit?</p> <p>In theory, layering is a way to decouple concerns so that UI concerns or data access technologies don't pollute the domain model. However, this style of architecture seems to come at a pretty steep price: there's a lot of mapping going on between the layers. Is it really worth the price, or is it OK to define data structures that cut across the various layers?</p> <p>The short answer is that if you cut across the layers, it's no longer a layered application. However, the price of layering may still be too high.</p> <p>In this post I'll examine the problem and the proposed solution and demonstrate why none of them are particularly good. In the end, I'll provide a pointer going forward.</p> <p><strong>Proper Layering</strong></p> <p>To understand the problem with layering, I'll describe a fairly simple example. Assume that you are building a music service and you've been asked to render a top 10 list for the day. It would have to look something like this in a web page:</p> <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Top10Tracks" border="0" alt="Top10Tracks" src="http://blog.ploeh.dk/content/binary/Windows-Live-Writer/04fbdab3357e_11E24/Top10Tracks_1.png" width="494" height="250"></p> <p>As part of rending the list, you must color the <em>Movement</em> values accordingly using CSS.</p> <p>A properly layered architecture would look something like this:</p> <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="ProperLayering" border="0" alt="ProperLayering" src="http://blog.ploeh.dk/content/binary/Windows-Live-Writer/04fbdab3357e_11E24/ProperLayering_3.png" width="385" height="480"></p> <p>Each layer defines some services and some data-carrying classes (<em>Entities</em>, if you want to stick with the <a href="http://www.amazon.com/gp/product/0321125215/ref=as_li_ss_tl?ie=UTF8&amp;tag=ploeh-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0321125215">Domain-Driven Design</a> terminology). The Track class is defined by the Domain layer, while the TopTrackViewModel class is defined in the User Interface layer, and so on. If you are wondering about why Track is used to communicate both up and down, this is because the Domain layer should be the most decoupled layer, so the other layers exist to serve it. In fact, this is just a vertical representation of the Ports and Adapters architecture, with the Domain Model sitting in the center.</p> <p>This architecture is very decoupled, but comes at the cost of much mapping and seemingly redundant repetition. To demonstrate why that is, I'm going to show you some of the code. This is an ASP.NET MVC application, so the Controller is an obvious place to start:</p> <div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">ViewResult</font></span> Index()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> date = <span style="color: "><font color="#2b91af">DateTime</font></span>.Now.Date;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> topTracks = <span style="color: "><font color="#0000ff">this</font></span>.trackService.GetTopFor(date);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.View(topTracks);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>This doesn't look so bad. It asks an ITrackService for the top tracks for the day and returns a list of TopTrackViewModel instances. This is the implementation of the track service:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">IEnumerable</font></span>&lt;<span style="color: "><font color="#2b91af">TopTrackViewModel</font></span>&gt; GetTopFor(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">DateTime</font></span> date)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> today = <span style="color: "><font color="#2b91af">DateTime</font></span>.Now.Date;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> yesterDay = today - <span style="color: "><font color="#2b91af">TimeSpan</font></span>.FromDays(1);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> todaysTracks = </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.repository.GetTopFor(today).ToList();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> yesterdaysTracks = </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.repository.GetTopFor(yesterDay).ToList();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> length = todaysTracks.Count;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> positions = <span style="color: "><font color="#2b91af">Enumerable</font></span>.Range(1, length);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">from</font></span> tt <span style="color: "><font color="#0000ff">in</font></span> todaysTracks.Zip(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; positions, (t, p) =&gt;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> { Position = p, Track = t })</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">let</font></span> yp = (<span style="color: "><font color="#0000ff">from</font></span> yt <span style="color: "><font color="#0000ff">in</font></span> yesterdaysTracks.Zip(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; positions, (t, p) =&gt; </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font style="font-size: 10pt" color="#0000ff">new</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Position = p,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Track = t</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">where</font></span> yt.Track.Id == tt.Track.Id</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">select</font></span> yt.Position)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .DefaultIfEmpty(-1)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Single()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">let</font></span> cssClass = GetCssClass(tt.Position, yp)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">select</font></span> <span style="color: "><font color="#0000ff">new</font></span> </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">TopTrackViewModel</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Position = tt.Position,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Name = tt.Track.Name,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Artist = tt.Track.Artist,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CssClass = cssClass</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">private</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">static</font></span> <span style="color: "><font color="#0000ff">string</font></span> GetCssClass(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">int</font></span> todaysPosition, <span style="color: "><font color="#0000ff">int</font></span> yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (yesterdaysPosition &lt; 0)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"new"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (todaysPosition &lt; yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"up"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (todaysPosition == yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"same"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"down"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>While that looks fairly complex, there's really not a lot of mapping going on. Most of the work is spent getting the top 10 track for today and yesterday. For each position on today's top 10, the query finds the position of the same track on yesterday's top 10 and creates a TopTrackViewModel instance accordingly.</p>
<p>Here's the only mapping code involved:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">select</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">new</font></span> </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">TopTrackViewModel</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; Position = tt.Position,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; Name = tt.Track.Name,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; Artist = tt.Track.Artist,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; CssClass = cssClass</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">};</font></pre></div>
<p>This maps from a Track (a Domain class) to a TopTrackViewModel (a UI class).</p>
<p>This is the relevant implementation of the repository:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">IEnumerable</font></span>&lt;<span style="color: "><font color="#2b91af">Track</font></span>&gt; GetTopFor(<span style="color: "><font color="#2b91af">DateTime</font></span> date)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> dbTracks = <span style="color: "><font color="#0000ff">this</font></span>.GetTopTracks(date);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">foreach</font></span> (<span style="color: "><font color="#0000ff">var</font></span> dbTrack <span style="color: "><font color="#0000ff">in</font></span> dbTracks)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">yield</font></span> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">Track</font></span>(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dbTrack.Id,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dbTrack.Name,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dbTrack.Artist);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>You may be wondering about the translation from DbTrack to Track. In this case you can assume that the DbTrack class is a class representation of a database table, modeled along the lines of your favorite ORM. The Track class, on the other hand, is a proper object-oriented class which <a href="http://blog.ploeh.dk/2011/05/24/PokayokeDesignFromSmellToFragrance.aspx">protects its invariants</a>:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">class</font></span> </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">Track</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">readonly</font></span> <span style="color: "><font color="#0000ff">int</font></span> id;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">string</font></span> name;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">string</font></span> artist;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> Track(<span style="color: "><font color="#0000ff">int</font></span> id, <span style="color: "><font color="#0000ff">string</font></span> name, <span style="color: "><font color="#0000ff">string</font></span> artist)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (name == <span style="color: "><font color="#0000ff">null</font></span>)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">throw</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ArgumentNullException</font></span>(<span style="color: "><font color="#a31515">"name"</font></span>);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (artist == <span style="color: "><font color="#0000ff">null</font></span>)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">throw</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ArgumentNullException</font></span>(<span style="color: "><font color="#a31515">"artist"</font></span>);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.id = id;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.name = name;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.artist = artist;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">int</font></span> Id</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">get</font></span> { <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.id; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">string</font></span> Name</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">get</font></span> { <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.name; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font style="font-size: 10pt" color="#0000ff">set</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (<span style="color: "><font color="#0000ff">value</font></span> == <span style="color: "><font color="#0000ff">null</font></span>)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">throw</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ArgumentNullException</font></span>(<span style="color: "><font color="#a31515">"value"</font></span>);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.name = <span style="color: "><font color="#0000ff">value</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">string</font></span> Artist</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">get</font></span> { <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.artist; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font style="font-size: 10pt" color="#0000ff">set</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (<span style="color: "><font color="#0000ff">value</font></span> == <span style="color: "><font color="#0000ff">null</font></span>)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">throw</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ArgumentNullException</font></span>(<span style="color: "><font color="#a31515">"value"</font></span>);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.artist = <span style="color: "><font color="#0000ff">value</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>No ORM I've encountered so far has been able to properly address such invariants  -  particularly the non-default constructor seems to be a showstopper. This is the reason a separate DbTrack class is required, even for ORMs with so-called POCO support.</p>
<p>In summary, that's a lot of mapping. What would be involved if a new field is required in the top 10 table? Imagine that you are being asked to provide the release label as an extra column.</p>
<ol>
<li>A Label column must be added to the database schema and the DbTrack class. 
<li>A Label property must be added to the Track class. 
<li>The mapping from DbTrack to Track must be updated. 
<li>A Label property must be added to the TopTrackViewModel class. 
<li>The mapping from Track to TopTrackViewModel must be updated. 
<li>The UI must be updated.</li></ol>
<p>That's a lot of work in order to add a single data element, and this is even a read-only scenario! Is it really worth it?</p>
<p><strong>Cross-Cutting Entities</strong></p>
<p>Is strict separation between layers really so important? What would happen if Entities were allowed to travel across all layers? Would that really be so bad?</p>
<p>Such an architecture is often drawn like this:</p>
<p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="CrossCuttingEntities" border="0" alt="CrossCuttingEntities" src="http://blog.ploeh.dk/content/binary/Windows-Live-Writer/04fbdab3357e_11E24/CrossCuttingEntities_3.png" width="441" height="480"></p>
<p>Now, a single Track class is allowed to travel from layer to layer in order to avoid mapping. The controller code hasn't really changed, although the model returned to the View is no longer a sequence of TopTrackViewModel, but simply a sequence of Track instances:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">ViewResult</font></span> Index()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> date = <span style="color: "><font color="#2b91af">DateTime</font></span>.Now.Date;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> topTracks = <span style="color: "><font color="#0000ff">this</font></span>.trackService.GetTopFor(date);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.View(topTracks);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>The GetTopFor method also looks familiar:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">IEnumerable</font></span>&lt;<span style="color: "><font color="#2b91af">Track</font></span>&gt; GetTopFor(<span style="color: "><font color="#2b91af">DateTime</font></span> date)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> today = <span style="color: "><font color="#2b91af">DateTime</font></span>.Now.Date;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> yesterDay = today - <span style="color: "><font color="#2b91af">TimeSpan</font></span>.FromDays(1);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> todaysTracks = </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.repository.GetTopFor(today).ToList();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> yesterdaysTracks = </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.repository.GetTopFor(yesterDay).ToList();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> length = todaysTracks.Count;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> positions = <span style="color: "><font color="#2b91af">Enumerable</font></span>.Range(1, length);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">from</font></span> tt <span style="color: "><font color="#0000ff">in</font></span> todaysTracks.Zip(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; positions, (t, p) =&gt; </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> { Position = p, Track = t })</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">let</font></span> yp = (<span style="color: "><font color="#0000ff">from</font></span> yt <span style="color: "><font color="#0000ff">in</font></span> yesterdaysTracks.Zip(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; positions, (t, p) =&gt;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font style="font-size: 10pt" color="#0000ff">new</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Position = p,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Track = t</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">where</font></span> yt.Track.Id == tt.Track.Id</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">select</font></span> yt.Position)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .DefaultIfEmpty(-1)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Single()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">let</font></span> cssClass = GetCssClass(tt.Position, yp)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">select</font></span> Enrich(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tt.Track, tt.Position, cssClass);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">private</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">static</font></span> <span style="color: "><font color="#0000ff">string</font></span> GetCssClass(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">int</font></span> todaysPosition, <span style="color: "><font color="#0000ff">int</font></span> yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (yesterdaysPosition &lt; 0)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"new"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (todaysPosition &lt; yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"up"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (todaysPosition == yesterdaysPosition)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"same"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#a31515">"down"</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">private</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">static</font></span> <span style="color: "><font color="#2b91af">Track</font></span> Enrich(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">Track</font></span> track, <span style="color: "><font color="#0000ff">int</font></span> position, <span style="color: "><font color="#0000ff">string</font></span> cssClass)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; track.Position = position;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; track.CssClass = cssClass;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> track;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>Whether or not much has been gained is likely to be a subjective assessment. While mapping is no longer taking place, it's still necessary to assign a CSS Class and Position to the track before handing it off to the View. This is the responsibility of the new Enrich method:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">private</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">static</font></span> <span style="color: "><font color="#2b91af">Track</font></span> Enrich(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">Track</font></span> track, <span style="color: "><font color="#0000ff">int</font></span> position, <span style="color: "><font color="#0000ff">string</font></span> cssClass)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; track.Position = position;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; track.CssClass = cssClass;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> track;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>If not much is gained at the UI layer, perhaps the data access layer has become simpler? This is, indeed, the case:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#2b91af">IEnumerable</font></span>&lt;<span style="color: "><font color="#2b91af">Track</font></span>&gt; GetTopFor(<span style="color: "><font color="#2b91af">DateTime</font></span> date)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.GetTopTracks(date);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>If, hypothetically, you were asked to add a label to the top 10 table it would be much simpler:</p>
<ol>
<li>A Label column must be added to the database schema and the Track class. 
<li>The UI must be updated.</li></ol>
<p>This looks good. Are there any disadvantages? Yes, certainly. Consider the Track class:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">class</font></span> </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">Track</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">int</font></span> Id { <span style="color: "><font color="#0000ff">get</font></span>; <span style="color: "><font color="#0000ff">set</font></span>; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">string</font></span> Name { <span style="color: "><font color="#0000ff">get</font></span>; <span style="color: "><font color="#0000ff">set</font></span>; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">string</font></span> Artist { <span style="color: "><font color="#0000ff">get</font></span>; <span style="color: "><font color="#0000ff">set</font></span>; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">int</font></span> Position { <span style="color: "><font color="#0000ff">get</font></span>; <span style="color: "><font color="#0000ff">set</font></span>; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">string</font></span> CssClass { <span style="color: "><font color="#0000ff">get</font></span>; <span style="color: "><font color="#0000ff">set</font></span>; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>It also looks simpler than before, but this is actually not particularly beneficial, as it doesn't protect its invariants. In order to play nice with the ORM of your choice, it must have a <a href="http://blog.ploeh.dk/2011/05/30/DesignSmellDefaultConstructor.aspx">default constructor</a>. It also has <a href="http://blog.ploeh.dk/2011/05/26/CodeSmellAutomaticProperty.aspx">automatic properties</a>. However, most insidiously, it also somehow gained the Position and CssClass properties.</p>
<p>What does the Position property imply outside of the context of a top 10 list? A position in relation to what?</p>
<p>Even worse, why do we have a property called CssClass? CSS is a very web-specific technology so why is this property available to the Data Access and Domain layers? How does this fit if you are ever asked to build a native desktop app based on the Domain Model? Or a REST API? Or a batch job?</p>
<p>When Entities are allowed to travel along layers, the layers basically collapse. UI concerns and data access concerns will inevitably be mixed up. You may think you have layers, but you don't.</p>
<p>Is that such a bad thing, though?</p>
<p>Perhaps not, but I think it's worth pointing out:</p>
<blockquote>
<p>The choice is whether or not you want to build a layered application. If you want layering, the separation must be strict. If it isn't, it's not a layered application.</p></blockquote>
<p>There may be great benefits to be gained from allowing Entities to travel from database to user interface. Much mapping cost goes away, but you must realize that then you're no longer building a layered application  -  now you're building a web application (or whichever other type of app you're initially building).</p>
<p><strong>Further Thoughts</strong></p>
<p>It's a common question: <em>how hard is it to add a new field to the user interface?</em></p>
<p>The underlying assumption is that the field must somehow originate from a corresponding database column. If this is the case, mapping seems to be in the way.</p>
<p>However, if this is the major concern about the application you're currently building, it's a strong indication that you are building a CRUD application. If that's the case, <a href="http://msdn.microsoft.com/en-us/magazine/ee236415.aspx">you probably don't need a Domain Model at all</a>. Go ahead and let your ORM POCO classes travel up and down the stack, but don't bother creating layers: you'll be building a monolithic application no matter how hard you try not to.</p>
<p>In the end it looks as though none of the options outlined in this article are particularly good. Strict layering leads to too much mapping, and no mapping leads to monolithic applications. Personally, I've certainly written quite a lot of strictly layered applications, and while the separation of concerns was good, I was never happy with the mapping overhead.</p>
<p>At the heart of the problem is the CRUDy nature of many applications. In such applications, complex object graphs are traveling up and down the stack. The trick is to avoid complex object graphs.</p>
<p>Move less data around and things are likely to become simpler. This is one of the many interesting promises of <a href="http://abdullin.com/cqrs">CQRS</a>, and particularly it's asymmetric approach to data.</p>
<p>To be honest, I wish I had fully realized this when I started writing <a href="http://affiliate.manning.com/idevaffiliate.php?id=1150_236">my book</a>, but when I finally realized what I'd implicitly felt for long, it was to late to change direction. Rest assured that nothing in the book is fundamentally flawed. The patterns etc. still hold, but the examples could have been cleaner if the sample applications had taken a CQRS-like direction instead of strict layering.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author"><a href="http://moh-abed.com">Mohamed Abed</a></div>
	<div class="comment-content">I have came to the same sequence and conclusions and in my recent application I had the following setup:<br>
<br>
- Domain layer with rich objects and protected variations<br>
- Commands and Command handlers (write only) acting on the domain entities<br>
- Mapping domain layer using NHibernate (I thought at first to start by creating a different data model because of the constraints of orm on the domain, but i managed to get rid of most of them - like having a default but private constructor, and mapping private fields instead of public properties ...)<br>
<br>
- Read model which consist of view models.<br>
- Red model mapping layer which uses the orm to map view models to database directly (thus i got rid of mapping between view models and domains - but introduced a mapping between view models and database).<br>
- Query objects to query the read model.<br>
<br>
at the end of application i came to almost the same conclusion of not being happy with the mappings.<br>
<br>
- I have to map domain model to database.<br>
- I have to map between view models (read model) and database.<br>
- I have to map between view models and commands.<br>
- I have to map between commands and domain model.<br>
- Having many fine grained commands is good in terms of defining strict behaviors and ubiquitous language but at the cost of maintainability, now when i introduce a new field most probably will have to modify a database field, domain model, view model, two data mappings for domain model and view model, 1 or more command and command handlers, and UI !<br>
<br>
So taking the practice of CQRS for me enriched the domain a little, simplified the operations and separated it from querying, but complicated the implementation and maintenance of the application.<br>
<br>
So I am still searching for a better approach to gain the rich domain model behavior and simplifying maintenance and eliminate mappings.</div>
	<div class="comment-date">2012-02-10 02:16 UTC</div>
</div><div class="comment">
	<div class="comment-author">bitbonk</div>
	<div class="comment-content">Good article, thank you for that. <br>
<br>
I too have felt pain of a lot of useless mapping a lot times. But even for CRUD applications where the business rules do not change much, I still almost always take the pain and do the mapping because I have a deep sitting fear of monolthic apps and code rot. If I give my entities lots of different concerns (UI, persistence, domainlogic etc.), isn't this kind of code smell the culture medium for more code smell and code rot? When evolving my application and I am faced with a quirk in my code, I often only have two choices: Add a new quirk or remove the original quirk. It kind of seems that in the long run a rotten monolithic app that his hard to maintain and extend becomes almost inevitable if I give up SoC the way you described.<br>
<br>
Did I understand you correctly that you'd say it's OK to soften SoC a bit and let the entity travel across all layers for *some* apps? If yes, what kind of apps? Do you share my fear of inevitable code rot? How do you deal with this?</div>
	<div class="comment-date">2012-02-10 09:11 UTC</div>
</div><div class="comment">
	<div class="comment-author">Jonty</div>
	<div class="comment-content">NHibernate allows protected constructors and setters, is that good enough? RavenDB allows private constructor and setters.</div>
	<div class="comment-date">2012-02-10 13:30 UTC</div>
</div><div class="comment">
	<div class="comment-author">Harry McIntyre</div>
	<div class="comment-content">I think you might be interested to hear about the stack I use.<br>
<br>
I use either convention based NH mappings which make me almost forget it's there, or MemoryImage to reconstruct my object model (the boilerplate is reduced by wrapping my objects with proxies that intercept method calls and record them as a json Event Source). In both cases I can use a helper library which wraps my objects with proxies that help protect invariants.<br>
<br>
My web UI is built using a framework along the lines of the Naked Object a pattern*, which can be customised using ViewModels and custom views, and which enforces good REST design. This framework turns objects into pages and methods into ajax forms.<br>
<br>
I built all this stuff after getting frustrated with the problems you mention above, inspired in part by all the time I spent at Uni trying to make games (in which an in memory domain model is rendered to the screen by a disconnected rendering engine, and input collected via a separate  mechanism and applied to that model). <br>
<br>
The long of the short of it is that I can add a field to the screen in seconds, and add a new feature in minutes. There are some trade offs, but it's great to feel like I am just writing an object model and leaving the rest to my frameworks. <br>
<br>
*not Naked Objects MVC, a DIY library thats not ready for the public yet.<br>
<br>
http://en.wikipedia.org/wiki/Naked_objects<br>
https://github.com/mcintyre321/NhCodeFirst my mappings lib (but Fluent NH is probably fine)<br>
http://martinfowler.com/bliki/MemoryImage.html<br>
https://github.com/mcintyre321/Harden my invariant helper library</div>
	<div class="comment-date">2012-02-10 16:44 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">bitbonk, that wasn't what I said at all. On the contrary, the point of the post is that as soon as you soften separation of concerns just a bit, it becomes impossible to maintain that separation. It's an all-or-nothing proposition. Either you maintain strict separation, or you'd be building a monolithic application whether you know it or not.<br>
<br>
The only thing I'm saying is that it's better to build a monolithic application when you know and understand that this is what you are doing, than it is to be building a monolithic application while under the illusion that you are building a decoupled application.</div>
	<div class="comment-date">2012-02-10 16:46 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Jonty: I don't know... How does protected or private constructors or properties help protect invariants?</div>
	<div class="comment-date">2012-02-10 16:48 UTC</div>
</div><div class="comment">
	<div class="comment-author">nelson</div>
	<div class="comment-content">I understand where you are coming from; but good architecture has always been at odds with RAD. You do make some good points, but as you certainly know, discipline in software design is very important. Many applications we build as &quot;one-offs&quot; are in production for years - and taking the RAD approach almost always results in software that everyone despises (especially the programmer left maintaining it). Proof: COBOL, Office VBA, Ruby on Rails. How many applications were built off of these platforms because it was easier and faster to get started, only to have the resulting codebase become something that doesn't work for anyone? We use C# and good design principles specifically to avoid this scenario. If I were to be in a position where I truly (absolutely truly) knew I wanted a CRUD app, I'd throw it together in Rails - then scrap that project once it grows too complex in favor of CQRS/C#/ASP.net MVC.<br>
<br>
If there's a point in there, it's that static languages (without designers) generally don't lend well to RAD, and if RAD is what you need, you have many popular options that aren't C#.<br>
<br>
Also, I have two problems with some of the sample code you wrote. Specifically, the Enrich method. First, a method signature such as:<br>
<br>
T Method(T obj, ...);<br>
<br>
Implies to consumers that the method is pure. Because this isn't the case, consumers will incorrectly use this method without the intention of modifying the original object. Second, if it is true that your ViewModels are POCOs consisting of your mapped properties AND a list of computed properties, perhaps you should instead use inheritance. This implementation is certainly SOLID:<br>
<br>
(sorry for the formatting)<br>
<br>
class Track <br>
{<br>
    /* Mapped Properties */ <br>
<br>
    public Track()<br>
    {<br>
    }<br>
<br>
    protected Track(Track rhs)<br>
    {<br>
        Prop1 = rhs.Prop1;<br>
        Prop2 = rhs.Prop2;<br>
        Prop3 = rhs.Prop3;<br>
    }<br>
}<br>
<br>
class TrackWebViewModel : Track <br>
{<br>
    public string ClssClass { get; private set; } <br>
<br>
    public TrackWebViewModel(Track track, string cssClass) : this(track)<br>
    {<br>
        CssClass = cssClass;<br>
    }<br>
}       <br>
<br>
let cssClass = GetCssClass(tt.Position, yp) select Enrich(tt.Track, tt.Position, cssClass)<br>
<br>
Simply becomes<br>
<br>
select new TrackWebViewModel(tt.Track, tt.Position, cssClass)</div>
	<div class="comment-date">2012-02-10 18:40 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">nelson, I never claimed the code in this post was supposed to represent <em>good</em> code :) Agreed that the Enrich method violates CQS.<br>
<br>
While your suggested, inheritance-based solution seems cleaner, please note that it also introduces a mapping (in the copy constructor). Once you start doing this, there's almost always a composition-based solution which is at least as good as the inheritance-based solution.</div>
	<div class="comment-date">2012-02-10 18:54 UTC</div>
</div><div class="comment">
	<div class="comment-author">nelson</div>
	<div class="comment-content">Oh, I certainly agree that inheritance should be avoided whenever possible. It's one of the most over (and improperly) used constructs in any OO language. I was simply writing an implementation that would work with your existing code with fewest changes as possible :) perhaps it was the maintainer in me talking, not the designer :p<br>
<br>
As far as the copy-ctor, yes, that is a mapping, but when you add a field, you just have to modify a file you're already modifying. This is a bit nicer than having to update mapping code halfway across your application. But you're right, composting a Track into a specific view model would be a nicer approach with fewer modifications required to add more view models and avoiding additional mapping.<br>
<br>
Though, I still am a bit concerned about the architecture as a whole. I understand in this post you were thinking out loud about a possible way to reduce complexity in certain types of applications, yet I'm wondering if you had considered using a platform designed for applications like this instead of using C#. Rails is quite handy when you need CRUD.</div>
	<div class="comment-date">2012-02-10 19:22 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Well, I was mainly attempting to address the perception that a lot of people have that decoupling creates a lot of mapping and therefore isn't worth the effort (their sentiment, not mine). Unfortunately, I have too little experience with technology stacks outside of .NET to be able to say something authoritative about them, but that particular positioning of Rails matches what I've previously heard.</div>
	<div class="comment-date">2012-02-10 19:30 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.sphereworks.dk">Anders Borum</a></div>
	<div class="comment-content">Hi Mark,<br>
<br>
thanks for the blog posts and DI book, which I'm currently reading over the weekend. I guess the scenario you're describing here is more or less commonplace, and as the team I'm working on are constantly bringing this subject up on the whiteboard, I thought I'd share a few thoughts on the mapping part. Letting the Track entity you're mentioning cross all layers is probably not a good idea.<br>
<br>
I agree that one should program to interfaces. Thus, any entity (be it an entity created via LINQ to SQL, EF, any other ORM/DAL or business object) should be modeled and exposed via an interface (or hierarchy thereof) from repositories or the like. With that in mind, here's what I think of mapping between entities. Popular ORM/DALs provide support for partial entities, external mapping files, POCOs, model-first etc.<br>
<br>
Take this simple example:<br>
<br>
// simplified pattern (deliberately not guarding args, and more)<br>
interface IPageEntity { string Name { get; }}<br>
class PageEntity : IPageEntity {}<br>
class Page : IPage<br>
{<br>
   private IPageEntity entity;<br>
   private IStrategy strategy;<br>
<br>
   public Page(IPageEntity entity, IStrategy strategy)<br>
  {<br>
     this.entity = entity;<br>
     this.strategy = strategy;<br>
  }<br>
<br>
   public string Name<br>
   {<br>
      get { return this.entity.Name; }<br>
      set { this.strategy.CopyOnWrite(ref this.entity).Name = value; }<br>
   }<br>
}<br>
<br>
One of the benefits from using an ORM/DAL is that queries are strongly typed and results are projected to strongly typed entities (concrete or anonymous). They are prime candidates for embedding inside of business objects (BO) (as DTOs), as long as they implement the required interface for injected in the constructor. This is much more flexible (and clean) rather than taking a series of arguments, each corresponding to a property on the original entity. Instead of having the BO keeping private members mapped to the constructor args, and subsequently mapping public properties and methods to said members, you simply map to the entity injected in the BO.<br>
<br>
The benefit is much greater performance (less copying of args), a consistent design pattern and a layer of indirection in your BO that allows you to capture any potential changes to your entity (such as using the copy-on-write pattern that creates an exact copy of the entity, releasing it from a potential shared cache you've created by decorating the repository, from which the entity originally was retrieved).<br>
<br>
Again, in my example one of the goals were to make use of shared (cached) entities for high performance, while making sure that there are no side effects from changing a business object (seeing this from client code perspective).<br>
<br>
Code following the above pattern is just as testable as the code in your example (one could argue it's even easier to write tests, and maintenance is vastly reduced). Whenever I see BO constructors taking huge amounts of args I cry blood.<br>
<br>
In my experience, this allows a strictly layered application to thrive without the mapping overhead.<br>
<br>
Your thoughts?</div>
	<div class="comment-date">2012-02-11 13:37 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="Http://www.planetgeek.ch">Daniel Marbach</a></div>
	<div class="comment-content">Hy<br>
What do you propose in cases when you have a client server application with request/response over WCF and the domain model living on the server? Is there a better way than for example mapping from NH entities to DataContracts and from DataContracts to ViewModels?<br>
<br>
Thnaks for the post!</div>
	<div class="comment-date">2012-02-13 05:46 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.null-node.com">Dave Brue</a></div>
	<div class="comment-content">I'm not certain the sample code you provided matches the first diagram... the diagram indicates that the Domain Layer only uses Track objects between the other layers. However you mention:<br>
<br>
&quot;... asks an ITrackService for the top tracks for the day and returns a list of <b>TopTrackViewModel</b> instances...&quot;<br>
<br>
The diagram really makes it look like the TrackService returns Track objects to the Controller and the Controller maps them into TopTrackViewModel objects. If that is the case... how would you communicate the Position and CssClass properties that the Domain Layer has computed between the two layers?<br>
<br>
Also, I noticed that ITrackService.GetTopFor(DateTime date) never uses the input parameter... should it really be more like ITrackService.GetTopForToday() instead?<br>
<br>
</div>
	<div class="comment-date">2012-02-13 19:10 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.dotnetcodegeeks.com/">Ilias Tsagklis</a></div>
	<div class="comment-content">Hi Mark,<br>
<br>
Awesome blog! Is there an email address I can contact you in private?</div>
	<div class="comment-date">2012-02-18 14:29 UTC</div>
</div><div class="comment">
	<div class="comment-author">Moss</div>
	<div class="comment-content">What about using your domain objects in the data access layer because you're not using an ORM and doing things manually, so that at least one level of mapping can be done away with? Or is that something that would command the question, why would you do a silly thing like that (not using an ORM)?</div>
	<div class="comment-date">2012-02-18 17:03 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Anders, I've been down the road of modeling Entities or Value Objects as interfaces, and it rarely leads to anywhere productive. The problem is that you end up with a lot of interfaces that mainly consists of properties (instead of methods). One day I'll attempt to write a long and formal exposition on why this is problematic, but for now I'll just hint that it violates the <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a> and leads to interface coupling as I quoted Jim Cooper for explaining in my <a href="http://blog.ploeh.dk/2012/02/02/LooseCouplingAndTheBigPicture.aspx">previous blog post</a>. Basically the problem is that such interfaces tend to be <a href="http://martinfowler.com/bliki/HeaderInterface.html">Header Interfaces</a>.</div>
	<div class="comment-date">2012-02-20 00:23 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Daniel, it's really hard to answer that question without knowing <em>why</em> that web service exists in the first place. If the only reason it exists is to facilitate communication between client and server, you may not need a translation layer. That's basically how WCF RIA services work. However, that tightly couples the client to the service, and you can't deploy or version each independently of the other.<br>
<br>
If the service layer exists in order to decouple the service from the client, you <em>must</em> translate from the internal model to a service API. However, if this is the case, keep in mind that <a href="http://blog.ploeh.dk/2011/05/31/AtTheBoundariesApplicationsAreNotObjectOriented.aspx">at the service boundary, you are no longer dealing with <em>objects</em> at all</a>, so translation or mapping is conceptually very important. If you have .NET on both sides it's easy to lose sight of this, but imagine that either service or client is implemented in COBOL and you may begin to understand the importance of translation.<br>
<br>
So as always, it's a question of evaluating the advantages and disadvantages of each alternative in the concrete situation. There's no one correct answer.</div>
	<div class="comment-date">2012-02-20 00:37 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Dave, well, yes, you are correct that the service in the code is actually part of the UI API. An error on my part, but I hope I still got the point of the blog post across. It doesn't change the conclusion in any way.</div>
	<div class="comment-date">2012-02-20 00:40 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Ilias, you can write me at mark at seemann dot (my initials).</div>
	<div class="comment-date">2012-02-20 00:42 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Moss, that's one of the reason I find NoSQL (particularly Event Sourcing) very attractive. There need be no mapping at the data access level - only serialization.<br>
<br>
Personally, I'm beginning to consider ORMs the right solution to the wrong problem. A relational database is rarely the correct data store for a LoB application or your typical web site.</div>
	<div class="comment-date">2012-02-20 00:46 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://flexdiary.blogspot.com">Amy</a></div>
	<div class="comment-content">Hi, Mark;<br>
<br>
Pardon me if I've gotten this wrong, because I'm approaching your post as an actionscript developer who is entirely self-taught. I don't know C#, but I like to read posts on good design from whatever language.<br>
<br>
How I might resolve this problem is to create a TrackDisplayModel Class that wraps the Track Class and provides the &quot;enriched&quot; methods of the position and cssClass. In AS, we have something called a Proxy Class that allows us to &quot;repeat&quot; methods on an inner object without writing a lot of code, so you could pass through the properties of the Track by making TrackDisplayModel extend Proxy. By doing this, I'd give up code completion and type safety, so I might not find that long term small cost worth the occasional larger cost of adding a field in more conventional ways.<br>
<br>
Does C# have a Class that is like Proxy that could be used in this way?</div>
	<div class="comment-date">2012-02-24 15:23 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.geekswithblogs.net/jboyer">Justin</a></div>
	<div class="comment-content">Excellent post. I really enjoyed reading it and it brings up a good point. Development is a world of trade-offs. Could this issue be helped with document databases such as RavenDB? You could conceivably create a JSON string that could be passed through all layers since the DB understands it intrinsically. Not sure of mapping implications but maybe some relief could be had for some applications. Unfortunately, many applications just aren't the right kinds for document databases as the technology still needs to mature some. Might not work for straight CRUD apps but I don't want to get into a document DB/RDBMS debate. Just a thought.</div>
	<div class="comment-date">2012-03-02 15:22 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Amy, while I think you're describing a dynamic approach with that Proxy class, it sounds actually rather close to normal inheritance to me. Basically, in C#, when you inherit from another class, all the base class' members are carried forward into the derived class. From C# 4 and onward, we also have dynamic typing, which would enable us to forego compilation and type safety for dynamic dispatching.<br>
<br>
No matter how you'd achieve such things, I'm not to happy about doing this, as most of the variability axes we get from a multi-paradigmatic language such as C# is additive - it means that while it's fairly easy to <em>add</em> new capabilities to objects, it's actually rather hard to <em>remove</em> capabilities.<br>
<br>
When we map from e.g. a domain model to a UI model, we should consider that we must be able to do both: add as well as subtract behavior. There may be members in our domain model we don't want the UI model to use.<br>
<br>
Also, when the application enables the user to write as well as read data, we must be able to map both ways, so this is another reason why we must be able to add as well as remove members when traversing layers.<br>
<br>
I'm not saying that a dynamic approach isn't viable - in fact, I find it attractive in various scenarios. I'm just saying that simply exposing a lower-level API to upper layers by adding more members to it seems to me to go against the spirit of the Single Responsibility Principle. It would just be tight coupling on the semantic level.</div>
	<div class="comment-date">2012-03-12 20:41 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Justin, if you pass JSON or any other type of untyped data up and down the layers, it would certainly remove the class coupling. The question is whether or not it would remove coupling in general. If you take a look at the <a href="http://blog.ploeh.dk/2012/02/02/LooseCouplingAndTheBigPicture.aspx">Jim Cooper quote here</a>, he's talking about semantic coupling, and you'd still have that because each layer would be coupled to a specific structure of the data that travels up and down.<br>
<br>
You might also want to refer to my answer to Amy immediately above. The data structures the UI requires may be entirely different from the Domain Model, which again could be different from the data access model. The UI will often be an aggregate of data from many different data sources.<br>
<br>
In fact, I'd consider it a code smell if you could get by with the same data structure in all layers. If one can do that, one is most likely building a CRUD application, in which case a monolithic RAD application might actually be a better architectural choice.</div>
	<div class="comment-date">2012-03-12 20:48 UTC</div>
</div><div class="comment">
	<div class="comment-author">Matt</div>
	<div class="comment-content">Mark,<br>
<br>
You've mentioned in your blogs (here and elsewhere) and on <a href="http://stackoverflow.com/a/9220361/452274">stackoverflow</a> simliar sentiments to your last comment:<br>
<br>
&lt;blockquote&gt;<br>
I'd consider it a code smell if you could get by with the same data structure in all layers. If one can do that, one is most likely building a <b>CRUD</b> application, in which case a monolithic RAD application might actually be a better architectural choice.<br>
&lt;/blockquote&gt;<br>
<br>
Most line of business (LoB) apps consist of CRUD operations. As such, when does an LoB app cross the line from being strictly &quot;CRUDy&quot; and jumps into the realm where where layering (or using CQRS) is preferable? Could you expand on your definition of <i>building a CRUD application</i>?<br>
</div>
	<div class="comment-date">2012-04-16 16:31 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Matt, I don't think there's any hard rule for that. Consider all the unknowns that are before you when you embark on a new project: this is one of those unknowns. In part, I base such decisions on gut feeling - you may call it experience...<br>
<br>
What I think would be the correct thing, on the other hand, would be to make a conscious decision <i>as a team</i> on which way to go. If the team agrees that the project is most likely a CRUD application, then it can save itself the trouble of having all those layers. However, it's very important to stress to non-technical team members and stake holders (project managers etc.) that there's a trade-off here: <i>We've decided to go with RAD development. This will enables us to go fast as long as our assumption about a minimum of business logic holds true. On the other hand, if that assumption fails, we'll be going very slowly.</i> Put it in writing and make sure those people understand this.<br>
<br>
You can also put it another way: creating a correctly layered application is slow, but relatively safe. Assuming that you know what you're doing with layering (lots of people don't), developing a layered application removes much of that risk. Such an architecture is going to be able to handle a lot of the changes you'll throw at it, but it'll be slow going.<br>
<br>
HTH</div>
	<div class="comment-date">2012-04-16 19:02 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.sapiensworks.com/blog">Mike</a></div>
	<div class="comment-content">My 2 euro cents: First of all, Track is  DTO as it has no behaviour. IF all the domain objects are like this, then you're pretty much building an interface for the db and in this case everything is quite clear (CRUD).<br>
<br>
If youre 'referring to the case where there is actually a domain to model, then CQRS (the concept) is easily the answer. However, even in such app you'd have some parts which are CRUD. I simply like to use the appropriate tool for the job. For complex Aggregate Roots, Event Sourcing simplifies storage a lot. For 'dumb' objects, directly CRUD stuff. Of course, everything is done via a repository.<br>
<br>
Now, for complex domain I'd also use a message driven architecture so I'd have Domain events with handlers which will generate any read model required. I won't really have a mapping problem as event sourcing will solve it for complex objects while for simple objects at most I'll automap or use the domain entities directly .<br>
</div>
	<div class="comment-date">2012-10-28 09:17 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.ebenroux.co.za">Eben</a></div>
	<div class="comment-content">Hi Mark,<br>
<br>
Nice blog!<br>
<br>
All the mapping stems from querying/reading the domain model.  I have come to the conclusion that this is what leads to all kinds of problems such as:<br>
<br>
- lazy loading<br>
- mapping<br>
- fetching strategies<br>
<br>
The domain model has state but should *do* stuff.  As you stated, the domain needs highly cohesive aggregates to get the object graph a short as possible.  I do not use an ORM (I do my own mapping) so I do not have ORM specific classes.<br>
<br>
So I am 100% with you on the CQRS.  There are different levels to doing CQRS and I think many folks shy away from it because they think there is only the all-or-nothing asynchronous messaging way to get to CQRS.  Yet there are various approaches depending on the need, e.g.:-<br>
<br>
All within the same transaction scope with no messaging (100% consistent):<br>
- store read data in same table (so different columns) &lt;-- probably the most typical option in this scenario<br>
- store read data in separate table in the same database<br>
- store read data in another table in another database<br>
<br>
Using eventual consistency via messaging / service bus (such as Shuttle - http://shuttle.codeplex.com/ | MassTransit | NServiceBus):<br>
<br>
- store read data in same table (so different columns)<br>
- store read data in separate table in the same database<br>
- store read data in another table in another database &lt;-- probably the most typical option in this scenario<br>
<br>
Using C# I would return the data from my query layer as a DataRow or DataTable and in the case of something more complex a DTO.<br>
<br>
Regards,<br>
Eben</div>
	<div class="comment-date">2013-01-18 08:38 UTC</div>
</div>
</div>