---
layout: post
tags: [Castle Windsor, Dependency Injection, Software Design]
date: 2010-09-20 19:18:21 UTC
title: "Instrumentation with Decorators and Interceptors"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p>One of my readers recently <a href="http://www.manning-sandbox.com/thread.jspa?forumID=607&amp;threadID=39542">asked me an interesting question</a>. It relates to <a href="http://www.manning.com/seemann/">my book</a>'s chapter about Interception (chapter 9) and Decorators and how they can be used for instrumentation-like purposes.</p> <p>In an earlier blog post we saw how we can <a href="http://blog.ploeh.dk/2010/04/07/DependencyInjectionIsLooseCoupling.aspx">use Decorators to implement Cross-Cutting Concerns</a>, but the question relates to how a set of Decorators can be used to log additional information about code execution, such as the time before and after a method is called, the name of the method and so on.</p> <p>A <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> can excellently address such a concern as well, as we will see here. Let us first define an IRegistrar interface and create an implementation like this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 \cf1 public\cf0  \cf1 class\cf0  \cf4 ConsoleRegistrar\cf0  : \cf4 IRegistrar\par ??\cf0 \{\par ??    \cf1 public\cf0  \cf1 void\cf0  Register(\cf4 Guid\cf0  id, \cf1 string\cf0  text)\par ??    \{\par ??        \cf1 var\cf0  now = \cf4 DateTimeOffset\cf0 .Now;\par ??        \cf4 Console\cf0 .WriteLine(\cf5 "\{0\}\\t\{1:s\}.\{2\}\\t\{3\}"\cf0 ,\par ??            id, now, now.Millisecond, text);\par ??    \}\par ??\}}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">ConsoleRegistrar</span> : <span style="color: #2b91af">IRegistrar</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Register(<span style="color: #2b91af">Guid</span> id, <span style="color: blue">string</span> text)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> now = <span style="color: #2b91af">DateTimeOffset</span>.Now;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">"{0}\t{1:s}.{2}\t{3}"</span>,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; id, now, now.Millisecond, text);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre></div>
<p>Although this implementation â€˜logs' to the Console, I'm sure you can imagine other implementations. The point is that given this interface, we can add all sorts of ambient information such as the thread ID, the name of the current principal, the current culture and whatnot, while the text string variable still gives us an option to log more information. If we want a more detailed API, we can just make it more detailed  -  after all, the IRegistrar interface is just an example.</p>
<p>We now know how to register events, but are seemingly no nearer to instrumenting an application. How do we do that? Let us see how we can instrument the <a href="http://blog.ploeh.dk/2010/02/02/RefactoringToAggregateServices.aspx">OrderProcessor class</a> that I have described several times in past posts.</p>
<p>At the place I left off, the OrderProcessor class uses Constructor Injection all the way down. Although I would normally prefer using a DI Container to auto-wire it, here's a manual composition using <em>Poor Man's DI</em> just to remind you of the general structure of the class and its dependencies:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 var\cf0  sut = \cf1 new\cf0  \cf4 OrderProcessor\cf0 (\par ??    \cf1 new\cf0  \cf4 OrderValidator\cf0 (), \par ??    \cf1 new\cf0  \cf4 OrderShipper\cf0 (),\par ??    \cf1 new\cf0  \cf4 OrderCollector\cf0 (\par ??        \cf1 new\cf0  \cf4 AccountsReceivable\cf0 (),\par ??        \cf1 new\cf0  \cf4 RateExchange\cf0 (),\par ??        \cf1 new\cf0  \cf4 UserContext\cf0 ()));}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> sut = <span style="color: blue">new</span> <span style="color: #2b91af">OrderProcessor</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderValidator</span>(), </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderShipper</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderCollector</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">AccountsReceivable</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">RateExchange</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">UserContext</span>()));</pre></div>
<p>All the dependencies injected into the OrderProcessor instance implement interfaces on which OrderProcessor relies. This means that we can decorate each concrete dependency with an implementation that instruments it.</p>
<p>Here's an example that instruments the IOrderProcessor interface itself:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 \cf1 public\cf0  \cf1 class\cf0  \cf4 InstrumentedOrderProcessor\cf0  : \cf4 IOrderProcessor\par ??\cf0 \{\par ??    \cf1 private\cf0  \cf1 readonly\cf0  \cf4 IOrderProcessor\cf0  orderProcessor;\par ??    \cf1 private\cf0  \cf1 readonly\cf0  \cf4 IRegistrar\cf0  registrar;\par ??\par ??    \cf1 public\cf0  InstrumentedOrderProcessor(\par ??        \cf4 IOrderProcessor\cf0  processor,\par ??        \cf4 IRegistrar\cf0  registrar)\par ??    \{\par ??        \cf1 if\cf0  (processor == \cf1 null\cf0 )\par ??        \{\par ??            \cf1 throw\cf0  \cf1 new\cf0  \cf4 ArgumentNullException\cf0 (\cf5 "processor"\cf0 );\par ??        \}\par ??        \cf1 if\cf0  (registrar == \cf1 null\cf0 )\par ??        \{\par ??            \cf1 throw\cf0  \cf1 new\cf0  \cf4 ArgumentNullException\cf0 (\cf5 "registrar"\cf0 );\par ??        \}\par ??\par ??        \cf1 this\cf0 .orderProcessor = processor;\par ??        \cf1 this\cf0 .registrar = registrar;\par ??    \}\par ??\par ??\cf1     #region\cf0  IOrderProcessor Members\par ??\par ??    \cf1 public\cf0  \cf4 SuccessResult\cf0  Process(\cf4 Order\cf0  order)\par ??    \{\par ??        \cf1 var\cf0  correlationId = \cf4 Guid\cf0 .NewGuid();\par ??        \cf1 this\cf0 .registrar.Register(correlationId,\par ??            \cf1 string\cf0 .Format(\cf5 "Process begins (\{0\})"\cf0 ,\par ??                \cf1 this\cf0 .orderProcessor.GetType().Name));\par ??\par ??        \cf1 var\cf0  result = \cf1 this\cf0 .orderProcessor.Process(order);\par ??\par ??        \cf1 this\cf0 .registrar.Register(correlationId,\par ??            \cf1 string\cf0 .Format(\cf5 "Process ends   (\{0\})"\cf0 , \par ??            \cf1 this\cf0 .orderProcessor.GetType().Name));\par ??\par ??        \cf1 return\cf0  result;\par ??    \}\par ??\par ??\cf1     #endregion\par ??\cf0 \}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">InstrumentedOrderProcessor</span> : <span style="color: #2b91af">IOrderProcessor</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IOrderProcessor</span> orderProcessor;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IRegistrar</span> registrar;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> InstrumentedOrderProcessor(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IOrderProcessor</span> processor,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IRegistrar</span> registrar)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (processor == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"processor"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (registrar == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"registrar"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.orderProcessor = processor;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar = registrar;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IOrderProcessor Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">SuccessResult</span> Process(<span style="color: #2b91af">Order</span> order)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> correlationId = <span style="color: #2b91af">Guid</span>.NewGuid();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar.Register(correlationId,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>.Format(<span style="color: #a31515">"Process begins ({0})"</span>,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.orderProcessor.GetType().Name));</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> result = <span style="color: blue">this</span>.orderProcessor.Process(order);</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar.Register(correlationId,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>.Format(<span style="color: #a31515">"Process ends&nbsp;&nbsp; ({0})"</span>, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.orderProcessor.GetType().Name));</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> result;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>That looks like quite a mouthful, but it's really quite simple  -  the cyclomatic complexity of the Process method is as low as it can be: <em>1</em>. We really just register the Process method call before and after invoking the decorated IOrderProcessor.</p>
<p>Without changing anything else than the composition itself, we can now instrument the IOrderProcessor interface:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 var\cf0  registrar = \cf1 new\cf0  \cf4 ConsoleRegistrar\cf0 ();\par ??\cf1 var\cf0  sut = \cf1 new\cf0  \cf4 InstrumentedOrderProcessor\cf0 (\par ??    \cf1 new\cf0  \cf4 OrderProcessor\cf0 (\par ??        \cf1 new\cf0  \cf4 OrderValidator\cf0 (),\par ??        \cf1 new\cf0  \cf4 OrderShipper\cf0 (),\par ??        \cf1 new\cf0  \cf4 OrderCollector\cf0 (\par ??            \cf1 new\cf0  \cf4 AccountsReceivable\cf0 (),\par ??            \cf1 new\cf0  \cf4 RateExchange\cf0 (),\par ??            \cf1 new\cf0  \cf4 UserContext\cf0 ())),\par ??    registrar);}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> registrar = <span style="color: blue">new</span> <span style="color: #2b91af">ConsoleRegistrar</span>();</pre><pre style="margin: 0px"><span style="color: blue">var</span> sut = <span style="color: blue">new</span> <span style="color: #2b91af">InstrumentedOrderProcessor</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderProcessor</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderValidator</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderShipper</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">OrderCollector</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">AccountsReceivable</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">RateExchange</span>(),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">UserContext</span>())),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; registrar);</pre></div>
<p>However, imagine implementing an InstrumentedXyz for every IXyz and compose the application with them. It's possible, but it's going to get old really fast  -  not to mention that it massively violates the DRY principle.</p>
<p>Fortunately we can solve this issue with any DI Container that supports dynamic interception. Castle Windsor does, so let's see how that could work.</p>
<p>Instead of implementing the same code â€˜template' over and over again to instrument an interface, we can do it once and for all with an interceptor. Imagine that we delete the InstrumentedOrderProcessor; instead, we create this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;\red163\green21\blue21;}??\fs20 \cf1 public\cf0  \cf1 class\cf0  \cf4 InstrumentingInterceptor\cf0  : \cf4 IInterceptor\par ??\cf0 \{\par ??    \cf1 private\cf0  \cf1 readonly\cf0  \cf4 IRegistrar\cf0  registrar;\par ??\par ??    \cf1 public\cf0  InstrumentingInterceptor(\cf4 IRegistrar\cf0  registrar)\par ??    \{\par ??        \cf1 if\cf0  (registrar == \cf1 null\cf0 )\par ??        \{\par ??            \cf1 throw\cf0  \cf1 new\cf0  \cf4 ArgumentNullException\cf0 (\cf5 "registrar"\cf0 );\par ??        \}\par ??\par ??        \cf1 this\cf0 .registrar = registrar;\par ??    \}\par ??\par ??\cf1     #region\cf0  IInterceptor Members\par ??\par ??    \cf1 public\cf0  \cf1 void\cf0  Intercept(\cf4 IInvocation\cf0  invocation)\par ??    \{\par ??        \cf1 var\cf0  correlationId = \cf4 Guid\cf0 .NewGuid();\par ??        \cf1 this\cf0 .registrar.Register(correlationId, \par ??            \cf1 string\cf0 .Format(\cf5 "\{0\} begins (\{1\})"\cf0 , \par ??                invocation.Method.Name,\par ??                invocation.TargetType.Name));\par ??\par ??        invocation.Proceed();\par ??\par ??        \cf1 this\cf0 .registrar.Register(correlationId,\par ??            \cf1 string\cf0 .Format(\cf5 "\{0\} ends   (\{1\})"\cf0 , \par ??                invocation.Method.Name, \par ??                invocation.TargetType.Name));\par ??    \}\par ??\par ??\cf1     #endregion\par ??\cf0 \}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">InstrumentingInterceptor</span> : <span style="color: #2b91af">IInterceptor</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IRegistrar</span> registrar;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> InstrumentingInterceptor(<span style="color: #2b91af">IRegistrar</span> registrar)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (registrar == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"registrar"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar = registrar;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IInterceptor Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Intercept(<span style="color: #2b91af">IInvocation</span> invocation)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> correlationId = <span style="color: #2b91af">Guid</span>.NewGuid();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar.Register(correlationId, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>.Format(<span style="color: #a31515">"{0} begins ({1})"</span>, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invocation.Method.Name,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invocation.TargetType.Name));</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invocation.Proceed();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.registrar.Register(correlationId,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>.Format(<span style="color: #a31515">"{0} ends&nbsp;&nbsp; ({1})"</span>, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invocation.Method.Name, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invocation.TargetType.Name));</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>If you compare this to the Process method of InstrumentedOrderProcessor (that we don't need anymore), you should be able to see that they are very similar. In this version, we just use the <em>invocation</em> argument to retrieve information about the decorated method.</p>
<p>We can now add InstrumentingInterceptor to a WindsorContainer and enable it for all appropriate components. When we do that and invoke the Process method on the resolved IOrderProcessor, we get a result like this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;}??\fs20   bbb9724e-0fad-4b06-9bb0-b8c1c460cded\tab 2010-09-20T21:01:16.744\tab Process begins (OrderProcessor)\par ??  43349d42-a463-463b-8ddf-e569e3170c97\tab 2010-09-20T21:01:16.745\tab Validate begins (TrueOrderValidator)\par ??  43349d42-a463-463b-8ddf-e569e3170c97\tab 2010-09-20T21:01:16.745\tab Validate ends   (TrueOrderValidator)\par ??  44fdccc8-f12d-4057-ae03-791225686504\tab 2010-09-20T21:01:16.746\tab Collect begins (OrderCollector)\par ??  8bbb1a0c-6134-4652-a4af-cd8c0c7184a0\tab 2010-09-20T21:01:16.746\tab GetCurrentUser begins (UserContext)\par ??  8bbb1a0c-6134-4652-a4af-cd8c0c7184a0\tab 2010-09-20T21:01:16.747\tab GetCurrentUser ends   (UserContext)\par ??  d54359ff-8c32-487f-8728-b19ff0bf4942\tab 2010-09-20T21:01:16.747\tab GetCurrentUser begins (UserContext)\par ??  d54359ff-8c32-487f-8728-b19ff0bf4942\tab 2010-09-20T21:01:16.747\tab GetCurrentUser ends   (UserContext)\par ??  c54c4506-23a8-4553-ba9a-066fc64252d2\tab 2010-09-20T21:01:16.748\tab GetSelectedCurrency begins (UserContext)\par ??  c54c4506-23a8-4553-ba9a-066fc64252d2\tab 2010-09-20T21:01:16.748\tab GetSelectedCurrency ends   (UserContext)\par ??  b3dba76b-6b4e-44fa-aca5-52b2d8509db3\tab 2010-09-20T21:01:16.750\tab Convert begins (RateExchange)\par ??  b3dba76b-6b4e-44fa-aca5-52b2d8509db3\tab 2010-09-20T21:01:16.751\tab Convert ends   (RateExchange)\par ??  e07765bd-fe07-4486-96f1-f74d77241343\tab 2010-09-20T21:01:16.751\tab Collect begins (AccountsReceivable)\par ??  e07765bd-fe07-4486-96f1-f74d77241343\tab 2010-09-20T21:01:16.752\tab Collect ends   (AccountsReceivable)\par ??  44fdccc8-f12d-4057-ae03-791225686504\tab 2010-09-20T21:01:16.752\tab Collect ends   (OrderCollector)\par ??  231055d3-4ebb-425d-8d69-fb9c85d9a860\tab 2010-09-20T21:01:16.752\tab Ship begins (OrderShipper)\par ??  231055d3-4ebb-425d-8d69-fb9c85d9a860\tab 2010-09-20T21:01:16.753\tab Ship ends   (OrderShipper)\par ??  bbb9724e-0fad-4b06-9bb0-b8c1c460cded\tab 2010-09-20T21:01:16.753\tab Process ends   (OrderProcessor)}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">&nbsp; bbb9724e-0fad-4b06-9bb0-b8c1c460cded&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.744&nbsp;&nbsp;&nbsp; Process begins (OrderProcessor)</pre><pre style="margin: 0px">&nbsp; 43349d42-a463-463b-8ddf-e569e3170c97&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.745&nbsp;&nbsp;&nbsp; Validate begins (TrueOrderValidator)</pre><pre style="margin: 0px">&nbsp; 43349d42-a463-463b-8ddf-e569e3170c97&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.745&nbsp;&nbsp;&nbsp; Validate ends&nbsp;&nbsp; (TrueOrderValidator)</pre><pre style="margin: 0px">&nbsp; 44fdccc8-f12d-4057-ae03-791225686504&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.746&nbsp;&nbsp;&nbsp; Collect begins (OrderCollector)</pre><pre style="margin: 0px">&nbsp; 8bbb1a0c-6134-4652-a4af-cd8c0c7184a0&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.746&nbsp;&nbsp;&nbsp; GetCurrentUser begins (UserContext)</pre><pre style="margin: 0px">&nbsp; 8bbb1a0c-6134-4652-a4af-cd8c0c7184a0&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.747&nbsp;&nbsp;&nbsp; GetCurrentUser ends&nbsp;&nbsp; (UserContext)</pre><pre style="margin: 0px">&nbsp; d54359ff-8c32-487f-8728-b19ff0bf4942&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.747&nbsp;&nbsp;&nbsp; GetCurrentUser begins (UserContext)</pre><pre style="margin: 0px">&nbsp; d54359ff-8c32-487f-8728-b19ff0bf4942&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.747&nbsp;&nbsp;&nbsp; GetCurrentUser ends&nbsp;&nbsp; (UserContext)</pre><pre style="margin: 0px">&nbsp; c54c4506-23a8-4553-ba9a-066fc64252d2&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.748&nbsp;&nbsp;&nbsp; GetSelectedCurrency begins (UserContext)</pre><pre style="margin: 0px">&nbsp; c54c4506-23a8-4553-ba9a-066fc64252d2&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.748&nbsp;&nbsp;&nbsp; GetSelectedCurrency ends&nbsp;&nbsp; (UserContext)</pre><pre style="margin: 0px">&nbsp; b3dba76b-6b4e-44fa-aca5-52b2d8509db3&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.750&nbsp;&nbsp;&nbsp; Convert begins (RateExchange)</pre><pre style="margin: 0px">&nbsp; b3dba76b-6b4e-44fa-aca5-52b2d8509db3&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.751&nbsp;&nbsp;&nbsp; Convert ends&nbsp;&nbsp; (RateExchange)</pre><pre style="margin: 0px">&nbsp; e07765bd-fe07-4486-96f1-f74d77241343&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.751&nbsp;&nbsp;&nbsp; Collect begins (AccountsReceivable)</pre><pre style="margin: 0px">&nbsp; e07765bd-fe07-4486-96f1-f74d77241343&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.752&nbsp;&nbsp;&nbsp; Collect ends&nbsp;&nbsp; (AccountsReceivable)</pre><pre style="margin: 0px">&nbsp; 44fdccc8-f12d-4057-ae03-791225686504&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.752&nbsp;&nbsp;&nbsp; Collect ends&nbsp;&nbsp; (OrderCollector)</pre><pre style="margin: 0px">&nbsp; 231055d3-4ebb-425d-8d69-fb9c85d9a860&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.752&nbsp;&nbsp;&nbsp; Ship begins (OrderShipper)</pre><pre style="margin: 0px">&nbsp; 231055d3-4ebb-425d-8d69-fb9c85d9a860&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.753&nbsp;&nbsp;&nbsp; Ship ends&nbsp;&nbsp; (OrderShipper)</pre><pre style="margin: 0px">&nbsp; bbb9724e-0fad-4b06-9bb0-b8c1c460cded&nbsp;&nbsp;&nbsp; 2010-09-20T21:01:16.753&nbsp;&nbsp;&nbsp; Process ends&nbsp;&nbsp; (OrderProcessor)</pre></div>
<p>Notice how we care easily see where and when method calls begin and end using the descriptive text as well as the correlation id. I will leave it as an exercise for the reader to come up with an API that provides better parsing options etc.</p>
<p>As a final note it's worth pointing out that this way of instrumenting an application (or part of it) can be done following the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">Open/Closed Principle</a>. I never changed the original implementation of any of the components.</p>
</div>
	