---
layout: post
tags: [Dependency Injection, StructureMap]
date: 2010-07-20 20:42:53 UTC
title: "StructureMap PerRequest vs. Unique lifetimes"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p><a href="http://structuremap.github.com/structuremap/">StructureMap</a> offers several different lifetimes, among these two known as <em>PerRequest</em> and <em>Unique</em> respectively. Recently I found myself wondering what was the difference between those two, but <a href="http://twitter.com/jeremydmiller/statuses/18865954515">a</a> <a href="http://twitter.com/jeremydmiller/statuses/18865987309">little</a> <a href="http://twitter.com/jeremydmiller/statuses/18866005435">help</a> from <a href="http://codebetter.com/blogs/jeremy.miller/">Jeremy Miller</a> put me on the right track.</p> <p>In short, <em>Unique</em> is equivalent to what <a href="http://castleproject.org/container/index.html">Castle Windsor</a> calls <em>Transient:</em> every time an instance of a type is needed, a new instance is created. Even if we need the same service multiple times in the same resolved graph, multiple instances are created.</p> <p><em>PerRequest</em>, on the other hand, is a bit special. Each type can be viewed as a <em>Singleton</em> within a single call to GetInstance, but as <em>Transient</em> across different invocations of GetInstance. In other words, the same instance will be shared within a resolved object graph, but if we resolve the same root type once more, we will get a new shared instance  -  a <em>Singleton</em> local to that graph.</p> <p>Here are some unit tests I wrote to verify this behavior (recall that PerRequest is StructureMap's default lifestyle):</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red43\green145\blue175;\red0\green0\blue255;}??\fs20 [\cf3 Fact\cf0 ]\par ??\cf4 public\cf0  \cf4 void\cf0  ResolveServicesWithSameUniqueDependency()\par ??\{\par ??    \cf4 var\cf0  container = \cf4 new\cf0  \cf3 Container\cf0 ();\par ??    container.Configure(x =&gt;\par ??    \{\par ??        \cf4 var\cf0  unique = \cf4 new\cf0  \cf3 UniquePerRequestLifecycle\cf0 ();\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().LifecycleIs(unique)\par ??            .Use&lt;\cf3 Shrimp\cf0 &gt;();\par ??        x.For&lt;\cf3 OliveOil\cf0 &gt;().LifecycleIs(unique);\par ??        x.For&lt;\cf3 EggYolk\cf0 &gt;().LifecycleIs(unique);\par ??        x.For&lt;\cf3 Vinegar\cf0 &gt;().LifecycleIs(unique);\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().LifecycleIs(unique)\par ??            .Use&lt;\cf3 Vinaigrette\cf0 &gt;();\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().LifecycleIs(unique)\par ??            .Use&lt;\cf3 Mayonnaise\cf0 &gt;();\par ??        x.For&lt;\cf3 Course\cf0 &gt;().LifecycleIs(unique);\par ??    \});\par ??\par ??    \cf4 var\cf0  c1 = container.GetInstance&lt;\cf3 Course\cf0 &gt;();\par ??    \cf4 var\cf0  c2 = container.GetInstance&lt;\cf3 Course\cf0 &gt;();\par ??\par ??    \cf3 Assert\cf0 .NotSame(\par ??        c1.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c1.Ingredients.OfType&lt;\cf3 Mayonnaise\cf0 &gt;().Single().Oil);\par ??    \cf3 Assert\cf0 .NotSame(\par ??        c2.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c2.Ingredients.OfType&lt;\cf3 Mayonnaise\cf0 &gt;().Single().Oil);\par ??    \cf3 Assert\cf0 .NotSame(\par ??        c1.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c2.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil);\par ??\}\par ??\par ??[\cf3 Fact\cf0 ]\par ??\cf4 public\cf0  \cf4 void\cf0  ResolveServicesWithSamePerRequestDependency()\par ??\{\par ??    \cf4 var\cf0  container = \cf4 new\cf0  \cf3 Container\cf0 ();\par ??    container.Configure(x =&gt;\par ??    \{\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().Use&lt;\cf3 Shrimp\cf0 &gt;();\par ??        x.For&lt;\cf3 OliveOil\cf0 &gt;();\par ??        x.For&lt;\cf3 EggYolk\cf0 &gt;();\par ??        x.For&lt;\cf3 Vinegar\cf0 &gt;();\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().Use&lt;\cf3 Vinaigrette\cf0 &gt;();\par ??        x.For&lt;\cf3 IIngredient\cf0 &gt;().Use&lt;\cf3 Mayonnaise\cf0 &gt;();\par ??    \});\par ??\par ??    \cf4 var\cf0  c1 = container.GetInstance&lt;\cf3 Course\cf0 &gt;();\par ??    \cf4 var\cf0  c2 = container.GetInstance&lt;\cf3 Course\cf0 &gt;();\par ??\par ??    \cf3 Assert\cf0 .Same(\par ??        c1.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c1.Ingredients.OfType&lt;\cf3 Mayonnaise\cf0 &gt;().Single().Oil);\par ??    \cf3 Assert\cf0 .Same(\par ??        c2.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c2.Ingredients.OfType&lt;\cf3 Mayonnaise\cf0 &gt;().Single().Oil);\par ??    \cf3 Assert\cf0 .NotSame(\par ??        c1.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil,\par ??        c2.Ingredients.OfType&lt;\cf3 Vinaigrette\cf0 &gt;().Single().Oil);\par ??\}}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">[<span style="color: #2b91af">Fact</span>]</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> ResolveServicesWithSameUniqueDependency()</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> container = <span style="color: blue">new</span> <span style="color: #2b91af">Container</span>();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; container.Configure(x =&gt;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> unique = <span style="color: blue">new</span> <span style="color: #2b91af">UniquePerRequestLifecycle</span>();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().LifecycleIs(unique)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Use&lt;<span style="color: #2b91af">Shrimp</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">OliveOil</span>&gt;().LifecycleIs(unique);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">EggYolk</span>&gt;().LifecycleIs(unique);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">Vinegar</span>&gt;().LifecycleIs(unique);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().LifecycleIs(unique)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Use&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().LifecycleIs(unique)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Use&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">Course</span>&gt;().LifecycleIs(unique);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; });</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> c1 = container.GetInstance&lt;<span style="color: #2b91af">Course</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> c2 = container.GetInstance&lt;<span style="color: #2b91af">Course</span>&gt;();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.NotSame(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.NotSame(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.NotSame(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">}</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">[<span style="color: #2b91af">Fact</span>]</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> ResolveServicesWithSamePerRequestDependency()</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> container = <span style="color: blue">new</span> <span style="color: #2b91af">Container</span>();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; container.Configure(x =&gt;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().Use&lt;<span style="color: #2b91af">Shrimp</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">OliveOil</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">EggYolk</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">Vinegar</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().Use&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x.For&lt;<span style="color: #2b91af">IIngredient</span>&gt;().Use&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; });</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> c1 = container.GetInstance&lt;<span style="color: #2b91af">Course</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> c2 = container.GetInstance&lt;<span style="color: #2b91af">Course</span>&gt;();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.Same(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.Same(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Mayonnaise</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.NotSame(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c2.Ingredients.OfType&lt;<span style="color: #2b91af">Vinaigrette</span>&gt;().Single().Oil);</pre><pre style="margin: 0px">}</pre></div>
<p>Notice that in both cases, the OliveOil instances are different across two independently resolved graphs (<em>c1</em> and <em>c2</em>).</p>
<p>However, within each graph, the same OliveOil instance is shared in the <em>PerRequest</em> configuration, whereas they are different in the <em>Unique</em> configuration.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author">Freddy Hansen</div>
	<div class="comment-content">Thank you, I had missed the subtle difference here and your post saved me :-)</div>
	<div class="comment-date">2012-10-23 18:58 UTC</div>
</div>
</div>