---
layout: post
tags: [AutoFixture]
date: 2009-04-23 19:51:42 UTC
title: "Dealing With Types Without Public Constructors"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p>Now that I've described how <a href="http://autofixture.codeplex.com/">AutoFixture</a> <a href="http://blog.ploeh.dk/2009/03/24/HowAutoFixtureCreatesObjects.aspx">creates objects</a>, it's time to look at a bit more advanced scenario. As you may recall, AutoFixture creates an object graph based on the public constructors of the types contained in that object graph.</p> <p>That's all well and good when all involved types have public constructors, but what happens when this is not the case?</p> <p>Imagine that the MyClass constructor has this signature:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 public\cf0  MyClass(\cf4 IMyInterface\cf0  mi)}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> MyClass(<span style="color: #2b91af">IMyInterface</span> mi)</pre></div>
<p>Since IMyInterface is an interface it has no public constructors, so this will not work:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red43\green145\blue175;\red255\green255\blue255;\red0\green0\blue0;\red0\green0\blue255;}??\fs20 \cf1 Fixture\cf0  fixture = \cf4 new\cf0  \cf1 Fixture\cf0 ();\par ??\cf1 MyClass\cf0  sut = fixture.CreateAnonymous&lt;\cf1 MyClass\cf0 &gt;();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">Fixture</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px"><span style="color: #2b91af">MyClass</span> sut = fixture.CreateAnonymous&lt;<span style="color: #2b91af">MyClass</span>&gt;();</pre></div>
<p>The second line of code will throw an <strike>ArgumentException</strike> ObjectCreationException* stating that “AutoFixture was unable to create an instance of type Ploeh.QualityTools.AutoFixtureDocumentationTest.Intermediate.IMyInterface, since it has no public constructor.” Not terribly surprising, actually.</p>
<p>To resolve this issue, the Register method allows you to specify a custom function that creates an object of the requested type. In the case of IMyInterface, that would be a Func&lt;IMyInterface&gt;:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red43\green145\blue175;\red255\green255\blue255;\red0\green0\blue0;\red0\green0\blue255;}??\fs20 \cf1 Fixture\cf0  fixture = \cf4 new\cf0  \cf1 Fixture\cf0 ();\par ??fixture.Register&lt;\cf1 IMyInterface\cf0 &gt;(() =&gt; \par ??    \cf4 new\cf0  \cf1 FakeMyInterface\cf0 ());\par ??\cf1 MyClass\cf0  sut = fixture.CreateAnonymous&lt;\cf1 MyClass\cf0 &gt;();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">Fixture</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px">fixture.Register&lt;<span style="color: #2b91af">IMyInterface</span>&gt;(() =&gt; </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">FakeMyInterface</span>());</pre><pre style="margin: 0px"><span style="color: #2b91af">MyClass</span> sut = fixture.CreateAnonymous&lt;<span style="color: #2b91af">MyClass</span>&gt;();</pre></div>
<p>Here, I use a lambda expression to register the FakeMyInterface type, so that every time that particular Fixture instance is asked to create an instance of IMyInterface, it will invoke the lambda expression, and thus return an instance of FakeMyInterface (which obviously implements IMyInterface).</p>
<p>The Register method simply lets you map types without public constructors to concrete types created by a function you specify.</p>
<p>A more advanced scenario arises if you wish to use a specific text with this FakeMyInterface constructor overload:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;}??\fs20 \cf1 public\cf0  FakeMyInterface(\cf1 int\cf0  number, \cf1 string\cf0  text)}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> FakeMyInterface(<span style="color: blue">int</span> number, <span style="color: blue">string</span> text)</pre></div>
<p>Obviously, you can do it manually like this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red43\green145\blue175;\red255\green255\blue255;\red0\green0\blue0;\red0\green0\blue255;\red163\green21\blue21;}??\fs20 \cf1 Fixture\cf0  fixture = \cf4 new\cf0  \cf1 Fixture\cf0 ();\par ??\cf4 int\cf0  anonymousNumber = fixture.CreateAnonymous&lt;\cf4 int\cf0 &gt;();\par ??\cf4 string\cf0  knownText = \cf5 "This text is not anonymous"\cf0 ;\par ??fixture.Register&lt;\cf1 IMyInterface\cf0 &gt;(() =&gt; \par ??    \cf4 new\cf0  \cf1 FakeMyInterface\cf0 (anonymousNumber, knownText));}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">Fixture</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px"><span style="color: blue">int</span> anonymousNumber = fixture.CreateAnonymous&lt;<span style="color: blue">int</span>&gt;();</pre><pre style="margin: 0px"><span style="color: blue">string</span> knownText = <span style="color: #a31515">"This text is not anonymous"</span>;</pre><pre style="margin: 0px">fixture.Register&lt;<span style="color: #2b91af">IMyInterface</span>&gt;(() =&gt; </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">FakeMyInterface</span>(anonymousNumber, knownText));</pre></div>
<p>Here, I simply use the fixture object to create an anonymous number, while the knownText variable is explicitly assigned a value, and then both are used as outer variables in the Register function.</p>
<p>This is, however, a common scenario, so the Register method has some convenience overloads that will supply anonymous input parameters for you to use or throw away as you like. This means that I can rewrite the above example to this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red43\green145\blue175;\red255\green255\blue255;\red0\green0\blue0;\red0\green0\blue255;\red163\green21\blue21;}??\fs20 \cf1 Fixture\cf0  fixture = \cf4 new\cf0  \cf1 Fixture\cf0 ();\par ??\cf4 string\cf0  knownText = \cf5 "This text is not anonymous"\cf0 ;\par ??fixture.Register&lt;\cf4 int\cf0 , \cf4 string\cf0 , \cf1 IMyInterface\cf0 &gt;((i, s) =&gt; \par ??    \cf4 new\cf0  \cf1 FakeMyInterface\cf0 (i, knownText));}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">Fixture</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px"><span style="color: blue">string</span> knownText = <span style="color: #a31515">"This text is not anonymous"</span>;</pre><pre style="margin: 0px">fixture.Register&lt;<span style="color: blue">int</span>, <span style="color: blue">string</span>, <span style="color: #2b91af">IMyInterface</span>&gt;((i, s) =&gt; </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">FakeMyInterface</span>(i, knownText));</pre></div>
<p>Compared to the previous example, I save a line of code. The drawback is that I have to explicitly specify the type parameters to the Register method. In my book, that's a pretty good tradeoff, as it removes a line of irrelevant code, and allows the test to focus on the relevant parts.</p>
<p>Notice that this Register overload creates both an anonymous integer and an anonymous string, but since I don't want to use the anonymous string (s), I just ignore it and use the knownText variable instead.</p>
<p><strong>*Edit (2009-09-02): </strong>Changed the name of the Exception type to correctly reflect a breaking change introduced in <a href="http://blog.ploeh.dk/2009/09/02/AutoFixture85Released.aspx">AutoFixture .8.5</a>.</p>
</div>
	