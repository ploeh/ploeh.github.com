---
layout: post
tags: [AutoFixture, Unit Testing]
date: 2009-10-26 20:26:49 UTC
title: "Anonymous With"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p>A few months ago I described how you can use <a href="http://autofixture.codeplex.com/">AutoFixture</a>'s <a href="http://blog.ploeh.dk/2009/06/01/SettingPropertyValuesWhileBuildingAnonymousVariablesWithAutoFixture.aspx">With method</a> to assign property values as part of building up an anonymous variable. In that scenario, the With method is used to explicitly assign a particular, pre-defined value to a property.</p> <p>There's another overload of the With method that <em>doesn't</em> take an explicit value, but rather uses AutoFixture to create an anonymous value for the property. So what's the deal with that if AutoFixture's default behavior is to assign anonymous values to all writable properties?</p> <p>In short it's an opt-in mechanism that only makes sense if you decide to opt out of the AutoProperties features.</p> <p>As always, let's look at an example. This time, I've decided to show you a slightly more realistic example so that you can get an idea of how AutoFixture can be used to aid in unit testing. This also means that the example is going to be a little more complex than usual, but it's still simple.</p> <p>Imagine that we wish to test that an ASP.NET MVC Controller Action returns the correct result. More specifically, we wish to test that the Profile method on MyController returns a ViewResult with the correct Model (the current user's name, to make things interesing).</p> <p>Here's the entire test. It may look more complicated than it is  -  it's really only 10 lines of code, but I had to break them up to prevent unpleasant wrapping if your screen is narrow.</p> <div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">[<span style="color: #2b91af">TestMethod</span>]</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> ProfileWillReturnResultWithCorrectUserName()</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Fixture setup</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; fixture.Customize&lt;<span style="color: #2b91af">ControllerContext</span>&gt;(ob =&gt; ob</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .OmitAutoProperties()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .With(cc =&gt; cc.HttpContext));</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> expectedUserName = </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous(<span style="color: #a31515">"UserName"</span>);</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> httpCtxStub = <span style="color: blue">new</span> <span style="color: #2b91af">Mock</span>&lt;<span style="color: #2b91af">HttpContextBase</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; httpCtxStub.SetupGet(x =&gt; x.User).Returns(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">GenericPrincipal</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">GenericIdentity</span>(expectedUserName), <span style="color: blue">null</span>));</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; fixture.Register(httpCtxStub.Object);</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> sut = fixture.Build&lt;<span style="color: #2b91af">MyController</span>&gt;()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .OmitAutoProperties()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .With(c =&gt; c.ControllerContext)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CreateAnonymous();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Exercise system</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ViewResult</span> result = sut.Profile();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Verify outcome</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> actual = result.ViewData.Model;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.AreEqual(expectedUserName, actual, <span style="color: #a31515">"User"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Teardown</span></pre><pre style="margin: 0px">}</pre></div>
<p>Apart from AutoFixture, I'm also making use of <a href="http://code.google.com/p/moq/">Moq</a> to stub out HttpContextBase.</p>
<p>You can see the Anonymous With method in two different places: in the call to <a href="http://blog.ploeh.dk/2009/09/22/CustomizingATypesBuilderWithAutoFixture.aspx">Customize</a> and when the <a href="http://xunitpatterns.com/SUT.html">SUT</a> is being built. In both cases you can see that the call to With follows a call to OmitAutoProperties. In other words: we are telling AutoFixture that we don't want any of the writable properties to be assigned a value <em>except</em> the one we identify.</p>
<p>Let me highlight some parts of the test.</p>
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">fixture.Customize&lt;<span style="color: #2b91af">ControllerContext</span>&gt;(ob =&gt; ob</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .OmitAutoProperties()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .With(cc =&gt; cc.HttpContext));</pre></div>
<p>This line of code instructs AutoFixture to always create a ControllerContext in a particular way: I don't want to use AutoProperties here, because ControllerContext has a lot of writable properties of abstract types, and that would require me to set up a lot of Test Doubles if I had to assign values to all of those. It's much easier to simply opt out of this mechanism. However, I <em>would</em> like to have the HttpContext property assigned, but I don't care about the value in this statement, so the With method simply states that AutoFixture should assign a value according to whatever rule it has for creating instances of HttpContextBase.</p>
<p>I can now set up a Stub that populates the User property of HttpContextBase:</p>
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> httpCtxStub = <span style="color: blue">new</span> <span style="color: #2b91af">Mock</span>&lt;<span style="color: #2b91af">HttpContextBase</span>&gt;();</pre><pre style="margin: 0px">httpCtxStub.SetupGet(x =&gt; x.User).Returns(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">GenericPrincipal</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">GenericIdentity</span>(expectedUserName), <span style="color: blue">null</span>));</pre><pre style="margin: 0px">fixture.Register(httpCtxStub.Object);</pre></div>
<p>This is registered with the fixture instance which closes the loop to the previous customization.</p>
<p>I can now create an instance of my SUT. Once more, I don't want to have to set up a lot of irrelevant properties on MyController, so I opt out of AutoProperties and then explicitly opt in on the ControllerContext. This will cause AutoFixture to automatically populate the ControllerContext with the HttpContext Stub:</p>
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> sut = fixture.Build&lt;<span style="color: #2b91af">MyController</span>&gt;()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .OmitAutoProperties()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .With(c =&gt; c.ControllerContext)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; .CreateAnonymous();</pre></div>
<p>For completeness' sake, here's the MyController class that I am testing:</p>
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">MyController</span> : <span style="color: #2b91af">Controller</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">ViewResult</span> Profile()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">object</span> userName = <span style="color: blue">this</span>.User.Identity.Name;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">this</span>.View(userName);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre></div>
<p>This test may seem complex, but it really accomplishes a lot in only 10 lines of code, considering that ASP.NET MVC Controllers with a working HttpContext are not particularly trivial to set up.</p>
<p>In summary, this With method overload lets you opt in on one or more explicitly identified properties when you have otherwise decided to omit AutoProperties. As all the other Builder methods, this method can also be chained.</p>
</div>
	