---
layout: post
tags: [AutoFixture, Dependency Injection, Software Design]
date: 2012-01-03 14:43:47 UTC
title: "SOLID is Append-only"
---
{% include JB/setup %}

<div id="post">
	<p><a href="http://en.wikipedia.org/wiki/Solid_%28object-oriented_design%29">SOLID</a> is a set of principles that, if applied consistently, has some surprising effect on code. In a <a href="http://blog.ploeh.dk/2011/06/07/SOLIDCodeIsnt.aspx">previous post</a> I provided a sketch of what it means to meticulously apply the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>. In this article I will describe what happens when you follow the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">Open/Closed Principle</a> (OCP) to its logical conclusion.</p> <p>In case a refresher is required, the OCP states that a class should be open for extension, but <em>closed for modification</em>. It seems to me that people often forget the second part. What does it mean?</p> <p>It means that once implemented, you <em>shouldn't touch that piece of code ever again</em> (unless you need to correct a bug).</p> <p>Then how can new functionality be added to a code base? This is still possible through either inheritance or polymorphic recomposition. Since the L in SOLID signifies the <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov Substitution Principle</a>, SOLID code tends to be based on loosely coupled code <em>composed</em> into an application through copious use of interfaces  -  basically, <a href="http://en.wikipedia.org/wiki/Strategy_pattern">Strategies</a> injected into other Strategies and so on (also due to <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency Inversion Principle</a>). In order to add functionality, you can create new implementations of these interfaces and redefine the application's <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot.aspx">Composition Root</a>. Perhaps you'd be wrapping existing functionality in a <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> or adding it to a <a href="http://en.wikipedia.org/wiki/Composite_pattern">Composite</a>.</p> <p>Once in a while, you'll stop using an old implementation of an interface. Should you then delete this implementation? What would be the point? At a certain point in time, this implementation was valuable. Maybe it will become valuable again. Leaving it as an potential building block seems a better choice.</p> <p>Thus, if we think about working with code as a CRUD endeavor, SOLID code can be Created and Read, but never Updated or Deleted. In other words, true SOLID code is append-only code.</p> <p><strong>Example: Changing AutoFixture's Number Generation Algorithm</strong></p> <p>In early 2011 <a href="http://autofixture.codeplex.com/workitem/4223">an issue was reported</a> for <a href="http://autofixture.codeplex.com/">AutoFixture</a>: Anonymous numbers were created in monotonically increasing sequences, but with separate sequences for each number type:</p> <p>integers: 1, 2, 3, 4, 5, …</p> <p>decimals: 1.0, 2.0, 3.0, 4.0, 5.0, …</p> <p>and so on. However, the person reporting the issue thought it made more sense if all numbers shared a single sequence. After thinking about it a little while, I agreed.</p> <p>Because the AutoFixture code base is fairly SOLID we decided to leave the old implementations in place and implement the new behavior in new classes.</p> <p>The old behavior was composed from a set of ISpecimenBuilders. As an example, integers were generated by this class:</p> <div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">class</font></span> <span style="color: "><font color="#2b91af">Int32SequenceGenerator</font></span> : </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">ISpecimenBuilder</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">int</font></span> i;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">int</font></span> CreateAnonymous()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#2b91af">Interlocked</font></span>.Increment(<span style="color: "><font color="#0000ff">ref</font></span> <span style="color: "><font color="#0000ff">this</font></span>.i);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">object</font></span> Create(<span style="color: "><font color="#0000ff">object</font></span> request,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">ISpecimenContext</font></span> context)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (request != <span style="color: "><font color="#0000ff">typeof</font></span>(<span style="color: "><font color="#0000ff">int</font></span>))</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">NoSpecimen</font></span>(request);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.CreateAnonymous();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>Similar implementations generated decimals, floats, doubles, etc. Instead of modifying any of these classes, we left them in the code base and created a new ISpecimenBuilder that generates all numbers from a single sequence:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">class</font></span> <span style="color: "><font color="#2b91af">NumericSequenceGenerator</font></span> : </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">ISpecimenBuilder</font></span></pre><pre style="margin: 0px"><font style="font-size: 10pt">{</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">int</font></span> value;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">object</font></span> Create(<span style="color: "><font color="#0000ff">object</font></span> request,</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">ISpecimenContext</font></span> context)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> type = request <span style="color: "><font color="#0000ff">as</font></span> <span style="color: "><font color="#2b91af">Type</font></span>;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (type == <span style="color: "><font color="#0000ff">null</font></span>)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">NoSpecimen</font></span>(request);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.CreateNumericSpecimen(type);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">object</font></span> CreateNumericSpecimen(<span style="color: "><font color="#2b91af">Type</font></span> request)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">var</font></span> typeCode = <span style="color: "><font color="#2b91af">Type</font></span>.GetTypeCode(request);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">switch</font></span> (typeCode)</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Byte:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">byte</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Decimal:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">decimal</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Double:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">double</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Int16:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">short</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Int32:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Int64:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">long</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.SByte:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">sbyte</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.Single:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">float</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.UInt16:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">ushort</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.UInt32:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">uint</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">case</font></span> <span style="color: "><font color="#2b91af">TypeCode</font></span>.UInt64:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> (<span style="color: "><font color="#0000ff">ulong</font></span>)<span style="color: "><font color="#0000ff">this</font></span>.GetNextNumber();</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">default</font></span>:</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">NoSpecimen</font></span>(request);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">int</font></span> GetNextNumber()</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#2b91af">Interlocked</font></span>.Increment(<span style="color: "><font color="#0000ff">ref</font></span> <span style="color: "><font color="#0000ff">this</font></span>.value);</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">}</font></pre></div>
<p>Adding a new class in itself has no effect, so in order to recompose the default behavior of AutoFixture, we changed a class called DefaultPrimitiveBuilders by removing the old ISpecimenBuilders like Int32SequenceGenerator and instead adding NumericSequenceGenerator:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">StringGenerator</font></span>(() =&gt; </font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#2b91af">Guid</font></span>.NewGuid());</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ConstrainedStringGenerator</font></span>();</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">StringSeedRelay</font></span>();</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">NumericSequenceGenerator</font></span>();</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">CharSequenceGenerator</font></span>();</font></pre><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">yield</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">RangedNumberGenerator</font></span>();</font></pre><pre style="margin: 0px"><span style="color: "><font style="font-size: 10pt" color="#008000">// even more builders...</font></span></pre></div>
<p>NumericSequenceGenerator is the fourth class being yielded here. Before we added NumericSequenceGenerator, this class instead yielded Int32SequenceGenerator and similar classes. These were removed.</p>
<p>The DefaultPrimitiveBuilders class is part of AutoFixture's default <a href="http://en.wikipedia.org/wiki/Facade_pattern">Facade</a> and is the closest we get to a Composition Root for the library. Recomposing this Facade enabled us to change the behavior of AutoFixture without modifying (other) existing classes.</p>
<p>As <a href="http://megakemp.wordpress.com/">Enrico</a> (who implemented this change) points out, the beauty is that the <a href="http://megakemp.wordpress.com/2011/09/06/behavior-changes-in-autofixture-2-2-anonymous-numbers/">previous behavior is still in the box</a>, and all it takes is a single method call to bring it back:</p>
<div style="font-family: ; background: white; color: "><pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> fixture = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">Fixture</font></span>().Customize(</font></pre><pre style="margin: 0px"><font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">NumericSequencePerTypeCustomization</font></span>());</font></pre></div>
<p>The only class we had to modify was the DefaultPrimitiveBuilders, which is where the object graph is composed. In applications this corresponds to the Composition Root, so even in the face of SOLID code, you still need to modify the Composition Root in order to recompose the application. However, use of a good DI Container and a strong set of conventions can do much to minimize the required editing of such a class.</p>
<p><strong>SOLID versus Refactoring</strong></p>
<p>SOLID is a goal I strive towards in the way I write code and design APIs, but I don't think I've ever written a significant code base which is perfectly SOLID. While I consider AutoFixture a ‘fairly' SOLID code base, it's not perfect, and I'm currently performing some design work in order to change some abstractions for version 3.0. This will require changing some of the existing types and thereby violating the OCP.</p>
<p>It's worth noting that as long as you can stick with the OCP you can avoid introducing breaking changes. A breaking change is also an OCP violation, so adhering to the OCP is more than just an academic exercise  -  particularly if you write reusable libraries.</p>
<p>Still, while none of my code is perfect and I occasionally have to refactor, I don't refactor much. By definition, refactoring means violating the OCP, and while I have nothing against refactoring code when it's required, I much prefer putting myself in a situation where it's rarely necessary in the first place.</p>
<p>I've often been derided for my lack of use of <a href="http://www.jetbrains.com/resharper/">Resharper</a>. When replying that I have little use for Resharper because I write SOLID code and thus don't do much refactoring, I've been ridiculed for being totally clueless. People don't realize the intimate relationship between SOLID and refactoring. I hope this post has helped highlight that connection.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author">Jon Wingfield</div>
	<div class="comment-content">I've found that it's very difficult to accomplish OCP in practice, mostly because of evolutionary design.  An example is having the foresight to know when the cohesion/coupling barrier has been crossed.  Also, when one gains greater insight into a domain, refactoring is necessary (even crucial).  but this violates OCP as well.  I find that my designs are pretty crappy up front but evolve as patterns emerge.  I prefer this to up-front engineering (except in some cases), because it yields a code base that is cohesive when appropriate, but also decoupled when appropriate.</div>
	<div class="comment-date">2012-01-03 16:09 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Agreed, OCP is <em>hard</em>.<br>
<br>
However, adhering to OCP doesn't indicate that you have to do BDUF. What it means is that once you get a 'rush of insight' (as <a href="http://www.amazon.com/gp/product/0321125215/ref=as_li_ss_tl?ie=UTF8&tag=ploeh-20&linkCode=as2&camp=1789&creative=390957&creativeASIN=0321125215">Domain-Driven Design</a> puts it) you don't <em>modify</em> existing classes. Instead, you introduce <em>new</em> classes to follow the new model.<br>
<br>
This may seem wasteful, but due to the <a href="http://blog.ploeh.dk/2011/06/07/SOLIDCodeIsnt.aspx">very fine-grained nature</a> of SOLID code, it means that those classes that follow the old model (that you've just realized can be improved) are basically 'wrong' because they model the domain in the 'wrong' way. Re-implementing that part of the application's behavior while leaving the old code in place is typically more efficient because it's only going to be a very small part of the code base (again due to the granularity) and because you can do it in micro-iterations since you're not changing anything. Thus, dangerous 'big-bang' refactorings are avoided.<br>
<br>
In any case, I never said that SOLID is easy. What I'm saying is that SOLID code has certain characteristics, and if a code base doesn't exhibit those characteristics, it's not (perfectly) SOLID. In reality, I expect that there are very few code bases that can live up to what is essentially an <em>ideal</em> more than a practically attainable goal.</div>
	<div class="comment-date">2012-01-03 16:42 UTC</div>
</div><div class="comment">
	<div class="comment-author">Jon Wingfield</div>
	<div class="comment-content">Not trying to spam your blog, but maybe OCP is better viewed as a means for enhancement, whereas refactoring is intended to improve the existing design.  Sometimes when adding functionality, we realize that the existing design doesn't accomodate change very well, and thus we refactor (hopefully separately from implementing new functionality).  I'm still a little uneasy about applying OCP when fixing bugs and especially design issues (which you already alleviated to).</div>
	<div class="comment-date">2012-01-03 17:33 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://hadihariri.com">Hadi Hariri</a></div>
	<div class="comment-content">Mark,<br>
<br>
Irrelevant of my association with ReSharper, I think that refactoring (be it with or without tools) and SOLID design are not mutually exclusive. You are basing your argument mostly on the premise that we get things right the first and that is not always the case. Test Driven Development in itself for instance is about evolving design. <br>
<br>
As for ReSharper not being needed (or replace ReSharper with any other enhancing tool), I find it kind of amusing because it seems that there is some imaginary line that developers draw whereby what's included in Visual Studio is sufficient when it comes to refactoring. Everything else is superflous. That is of course until the next version of Visual Studio includes it. And that's if we think about these types of tools as refactoring only, which is so far from the truth. <br>
<br>
Btw, switch statement violates OCP and yes it doesn't change until it does change. I'd add that normally when I violate OCP I try and make sure the tests are in pace to let me know if something breaks. <br>
</div>
	<div class="comment-date">2012-01-03 17:55 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Jon, that's well put.<br>
<br>
When it comes to fixing bugs, the OCP specifically states that it's OK to modify existing code, so you shouldn't be uneasy about that.</div>
	<div class="comment-date">2012-01-03 19:32 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Hadi, I'd never claim that it's possible to get things right on the first attempt. Looking at AutoFixture (again), I had to do a lot of refactoring and redesign to arrive at version 2.0, which is 'fairly' SOLID. Still, I have more changes in store for version 3.0, which indicates to me that it's <em>still</em> not SOLID - although it's vastly better than before.<br>
<br>
Still, instead of refactoring, sometimes it makes more sense to leave the old stuff to atrophy and build the new, better API up around it. That's basically the <a href="http://www.martinfowler.com/bliki/StranglerApplication.html">Strangler pattern</a> applied at the code level.<br>
<br>
That said, there are some of the refactorings that ReSharper has that I'd <em>love</em> to have in my IDE. It's just that I think that already VS is too slow and heavy on my machine - even without ReSharper...</div>
	<div class="comment-date">2012-01-03 19:42 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://http://jeff-sharp.blogspot.com/">Jeff Saunders</a></div>
	<div class="comment-content">You could build a whole set of tools around append-only programming; version control in particular would be a piece of cake. An editor that let you use a class or function as a starting point and then save an edited version as a new class or function (without affecting the existing version) would be quite helpful.<br>
<br>
I tried an extremely SOLID design for a prototype recently, with very few stable dependencies and leaning on the container for almost everything. I didn't quite adhere to OCP as you've described it here, but in retrospect it would have almost eliminated regressions. There was a lot of pushback to the design as soon as we got another developer on (just before we threw away the prototype), though.<br>
<br>
The usual complaints about being unable to see the big picture (due to container registrations being made mostly linearly) came through, and my choice to compose functions rather than objects certainly didn't help as it resulted in some quite foreign-looking code. I think tooling could have helped, but we've decided to stick to KISS and stabilise more dependencies for the upcoming releases.<br>
<br>
On the subject of tooling, I think something that's missing from DI tooling is a graphical designer containing a tree view of what your container will resolve at runtime, with markers for missing dependencies and such. A &quot;DIML&quot; file, perhaps, that generates a .diml.cs or .diml.vb when saved. Then you could have a find-and-replace-style feature for replacing dependencies, respecting OCP.</div>
	<div class="comment-date">2012-01-03 21:53 UTC</div>
</div><div class="comment">
	<div class="comment-author">Andreas Triesch</div>
	<div class="comment-content">This might seem a bit like a newbie question (well, with regards to SOLID I am one) - does that mean one should mostly use 'protected virtual' methods as opposed to 'private', in case I need something just a little different? Or does the notion I might need to do so in a particular case rather imply my class might be too large (violating SRP) and I should try to achieve flexibility by breaking it up and composing my logic via DI instead of using inheritance?</div>
	<div class="comment-date">2012-01-03 22:11 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://geekswithblogs.net/thearchitectsnapkin/Default.aspx">Ralf Westphal</a></div>
	<div class="comment-content">Let me support you, Mark, in not having much use for ReSharper.<br>
<br>
Event though I&#180;m using it, I&#180;m not using it much for refactoring. Out of all the refactorings I use maybe just 2-3 (rename, extract method, move class to separate file).<br>
<br>
My main use for ReSharper is as a test runner.<br>
<br>
So I agree: ReSharper is a tool for developers wrestling with tons of legacy code they need to refactor. But if your code base is clean... then the need for larger rearrangements is rare. &quot;Refactoring to deeper insight&quot; sometimes requires such rearrangements. But this too need not be that hard, if the functional units are fine grained.</div>
	<div class="comment-date">2012-01-04 10:15 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Jeff, I think that the use of a DI Container and application of the OCP are perpendicular concerns.<br>
<br>
Andreas, the 'old' definition of OCP (Meyer's) is to use inheritance to extend an existing class. However, when we favor composition over inheritance, the default way to extend a class is to apply a Decorator to it.<br>
<br>
Ralf, I think you've nailed it. The reason why I've never felt much need for ReSharper is because I avoid legacy code like the plague. In fact, I've turned down job offers (that payed better than anything I've ever received) because it involved dealing with too much legacy code. If I were ever to deal substantially with legacy code, I might very well install ReSharper.</div>
	<div class="comment-date">2012-01-04 18:30 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://jeff-sharp.blogspot.com/">Jeff Saunders</a></div>
	<div class="comment-content">Mark, you're right. I went off on a bit of a tangent! <br>
<br>
I guess the only relation that I was riffing off is that a great tool for writing and composing SOLID code would help with both.</div>
	<div class="comment-date">2012-01-04 19:32 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="https://twitter.com/#!/payman81">Payman</a></div>
	<div class="comment-content">You said that you don't refactor often. Does that mean that you don't practice TDD? As I understand it, refactoring is an essential step in each TDD cycle. <br>
Refactoring aside, it seems to me that TDD practice makes you violate OCP since you start with the simplest implementation and keep improving it (hence changing existing code) to make new tests pass.</div>
	<div class="comment-date">2012-03-17 08:51 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">Payman, I do practice TDD, and I do refactor regularly as part of the Red/Green/Refactor cycle.<br>
<br>
What I meant (but perhaps did not explicitly state) was that once a piece of code is released to production, it changes status. That kind of code I don't often refactor.</div>
	<div class="comment-date">2012-03-18 14:02 UTC</div>
</div>
</div>