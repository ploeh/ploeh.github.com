---
layout: post
tags: [Dependency Injection, Software Design]
date: 2010-04-07 19:49:11 UTC
title: "Dependency Injection is Loose Coupling"
---
{% include JB/setup %}

<div id="post">
	<p>It seems to me that I've lately encountered a particular mindset towards Dependency Injection (DI). People seem to think that it's only really good for replacing one data access implementation with another. Once you get to that point, you know that the following argument isn't far behind:</p> <blockquote> <p>“That's all well and good, but we know for certain that we will <em>never</em> exchange [insert name of RDBMS here] with anything else in this application.”</p></blockquote> <p>Apart from the hubris of making such a bold statement about the future of any software endeavor, such a statement reveals the narrow view on DI that its only purpose is for replacing data access components  -  and perhaps for unit testing.</p> <p>Those are relevant reasons for using DI, but they are only <em>some</em> of the reasons. Let's briefly revisit why we employ DI.</p> <p>We use DI to enable loose coupling.</p> <p>DI is only a means to an end. Even if you <em>never</em> intend to replace your database and even if you never want to write a single unit test, DI still offers benefits in form of a more maintainable code base. The loose coupling gives you better separation of concerns because it allows you to apply the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">Open/Closed Principle</a>.</p> <p>Example coming right up:</p> <p>Imagine that we need to implement a PrécisViewModel class with a TopSellers property that returns an IEnumerable&lt;string&gt;. To implement this class, we have a data access component. Let's use the ubiquitous Repository pattern and define IProductRepository to see where that leads us:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 interface\cf0  \cf2 IProductRepository\cf0 \par \{\par     \cf2 IEnumerable\cf0 &lt;\cf2 Product\cf0 &gt; SelectTopSellers();\par \}\par }
--> <div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">IProductRepository</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Product</span>&gt; SelectTopSellers();</pre><pre style="margin: 0px">}</pre></div>
<p>We can now implement PrécisViewModel like this:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;\red163\green21\blue21;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 Pr\uinput1\u233 &#233;cisViewModel\cf0 \par \{\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf2 IProductRepository\cf0  repository;\par \par     \cf1 public\cf0  Pr\uinput1\u233 &#233;cisViewModel(\cf2 IProductRepository\cf0  repository)\par     \{\par         \cf1 if\cf0  (repository == \cf1 null\cf0 )\par         \{\par             \cf1 throw\cf0  \cf1 new\cf0  \cf2 ArgumentNullException\cf0 (\cf3 "repository"\cf0 );\par         \}\par \par         \cf1 this\cf0 .repository = repository;\par     \}\par \par     \cf1 public\cf0  \cf2 IEnumerable\cf0 &lt;\cf1 string\cf0 &gt; TopSellers\par     \{\par         \cf1 get\cf0 \par         \{\par             \cf1 var\cf0  topSellers = \par                 \cf1 this\cf0 .repository.SelectTopSellers();\par             \cf1 return\cf0  \cf1 from\cf0  p \cf1 in\cf0  topSellers\par                    \cf1 select\cf0  p.Name;\par         \}\par     \}\par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PrécisViewModel</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IProductRepository</span> repository;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> PrécisViewModel(<span style="color: #2b91af">IProductRepository</span> repository)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (repository == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"repository"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository = repository;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: blue">string</span>&gt; TopSellers</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> topSellers = </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository.SelectTopSellers();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">from</span> p <span style="color: blue">in</span> topSellers</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">select</span> p.Name;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre></div>
<p>Nothing fancy is going on here. It's just straight Constructor Injection at work.</p>
<p>Obviously, we can now implement and use a SQL Server-based repository:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 var\cf0  repository = \cf1 new\cf0  \cf2 SqlProductRepository\cf0 ();\par \cf1 var\cf0  vm = \cf1 new\cf0  \cf2 Pr\uinput1\u233 &#233;cisViewModel\cf0 (repository);\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">var</span> repository = <span style="color: blue">new</span> <span style="color: #2b91af">SqlProductRepository</span>();</pre><pre style="margin: 0px"><span style="color: blue">var</span> vm = <span style="color: blue">new</span> <span style="color: #2b91af">PrécisViewModel</span>(repository);</pre></div>
<p>So what does all this loose coupling buy us? It doesn't seem to help us a lot.</p>
<p>The real benefit is not yet apparent, but it should become more obvious when we start adding requirements. Let's start with some caching. It turns out that the SelectTopSellers implementation is slow, so we would like to add some caching somewhere.</p>
<p>Where should we add this caching functionality? Without loose coupling, we would more or less be constrained to adding it to either PrécisViewModel or SqlProductRepository, but both have issues:</p>
<ul>
<li>First of all we would be violating the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a> (SRP) in both cases. 
<li>If we implement caching in PrécisViewModel, other consumers of the SelectTopSellers would not benefit from it. 
<li>If we implement caching in SqlProductRepository, it wouldn't be available for any other IProductRepository implementations.</li></ul>
<p>Since the premise for this post is that we will <em>never</em> use any other database than SQL Server, implementing caching directly in SqlProductRepository sounds like the correct choice, but we would still be violating the SRP, and thus making our code more difficult to maintain.</p>
<p>A better solution is to introduce a caching <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> like this one:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;\red163\green21\blue21;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 CachingProductRepository\cf0  : \cf2 IProductRepository\cf0 \par \{\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf2 ICache\cf0  cache;\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf2 IProductRepository\cf0  repository;\par \par     \cf1 public\cf0  CachingProductRepository(\par         \cf2 IProductRepository\cf0  repository, \cf2 ICache\cf0  cache)\par     \{\par         \cf1 if\cf0  (repository == \cf1 null\cf0 )\par         \{\par             \cf1 throw\cf0  \cf1 new\cf0  \cf2 ArgumentNullException\cf0 (\cf3 "repository"\cf0 );\par         \}\par         \cf1 if\cf0  (cache == \cf1 null\cf0 )\par         \{\par             \cf1 throw\cf0  \cf1 new\cf0  \cf2 ArgumentNullException\cf0 (\cf3 "cache"\cf0 );\par         \}\par \par         \cf1 this\cf0 .cache = cache;\par         \cf1 this\cf0 .repository = repository;\par     \}\par \par \cf1     #region\cf0  IProductRepository Members\par \par     \cf1 public\cf0  \cf2 IEnumerable\cf0 &lt;\cf2 Product\cf0 &gt; SelectTopSellers()\par     \{\par         \cf1 return\cf0  \cf1 this\cf0 .cache\par             .Retrieve&lt;\cf2 IEnumerable\cf0 &lt;\cf2 Product\cf0 &gt;&gt;(\cf3 "topSellers"\cf0 ,\par                 \cf1 this\cf0 .repository.SelectTopSellers);\par     \}\par \par \cf1     #endregion\cf0 \par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CachingProductRepository</span> : <span style="color: #2b91af">IProductRepository</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">ICache</span> cache;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IProductRepository</span> repository;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> CachingProductRepository(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IProductRepository</span> repository, <span style="color: #2b91af">ICache</span> cache)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (repository == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"repository"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (cache == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"cache"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.cache = cache;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository = repository;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IProductRepository Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Product</span>&gt; SelectTopSellers()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">this</span>.cache</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Retrieve&lt;<span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Product</span>&gt;&gt;(<span style="color: #a31515">"topSellers"</span>,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository.SelectTopSellers);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>For completeness sake is here the definition of ICache:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 interface\cf0  \cf2 ICache\cf0 \par \{\par     T Retrieve&lt;T&gt;(\cf1 string\cf0  key, \cf2 Func\cf0 &lt;T&gt; readThrough);\par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">ICache</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; T Retrieve&lt;T&gt;(<span style="color: blue">string</span> key, <span style="color: #2b91af">Func</span>&lt;T&gt; readThrough);</pre><pre style="margin: 0px">}</pre></div>
<p>The point is that CachingProductRepository <em>extends</em> any IProductRepository we provide to it (including SqlProductRepository) without modifying it. Thus, we have satisfied both the OCP and the SRP.</p>
<p>Just to drive home the point, let us assume that we also wish to record execution times for various methods for purposes of SLA compliance. We can do this by introducing yet another Decorator:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;\red163\green21\blue21;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 PerformanceMeasuringProductRepository\cf0  : \par     \cf2 IProductRepository\cf0 \par \{\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf2 IProductRepository\cf0  repository;\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf2 IStopwatch\cf0  stopwatch;\par \par     \cf1 public\cf0  PerformanceMeasuringProductRepository(\par         \cf2 IProductRepository\cf0  repository, \par         \cf2 IStopwatch\cf0  stopwatch)\par     \{\par         \cf1 if\cf0  (repository == \cf1 null\cf0 )\par         \{\par             \cf1 throw\cf0  \cf1 new\cf0  \cf2 ArgumentNullException\cf0 (\cf3 "repository"\cf0 );\par         \}\par         \cf1 if\cf0  (stopwatch == \cf1 null\cf0 )\par         \{\par             \cf1 throw\cf0  \cf1 new\cf0  \cf2 ArgumentNullException\cf0 (\cf3 "stopwatch"\cf0 );\par         \}\par         \par         \cf1 this\cf0 .repository = repository;\par         \cf1 this\cf0 .stopwatch = stopwatch;\par     \}\par \par \cf1     #region\cf0  IProductRepository Members\par \par     \cf1 public\cf0  \cf2 IEnumerable\cf0 &lt;\cf2 Product\cf0 &gt; SelectTopSellers()\par     \{\par         \cf1 var\cf0  timer = \cf1 this\cf0 .stopwatch\par             .StartMeasuring(\cf3 "SelectTopSellers"\cf0 );\par         \cf1 var\cf0  topSellers = \par             \cf1 this\cf0 .repository.SelectTopSellers();\par         timer.StopMeasuring();\par         \cf1 return\cf0  topSellers;\par     \}\par \par \cf1     #endregion\cf0 \par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PerformanceMeasuringProductRepository</span> : </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IProductRepository</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IProductRepository</span> repository;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IStopwatch</span> stopwatch;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> PerformanceMeasuringProductRepository(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IProductRepository</span> repository, </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IStopwatch</span> stopwatch)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (repository == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"repository"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (stopwatch == <span style="color: blue">null</span>)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"stopwatch"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository = repository;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.stopwatch = stopwatch;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IProductRepository Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Product</span>&gt; SelectTopSellers()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> timer = <span style="color: blue">this</span>.stopwatch</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .StartMeasuring(<span style="color: #a31515">"SelectTopSellers"</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> topSellers = </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.repository.SelectTopSellers();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timer.StopMeasuring();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> topSellers;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>Once again, we modified neither SqlProductRepository nor CachingProductRepository to introduce this new feature. We can implement security and auditing features by following the same principle.</p>
<p>To me, this is what loose coupling (and DI) is all about. That we can also replace data access components and unit test using dynamic mocks are very fortunate side effects, but the loose coupling is valuable in itself because it enables us to write more maintainable code.</p>
<p>We don't even need a DI Container to wire up all these repositories (although it sure would be helpful). Here's how we can do it with Poor Man's DI:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red43\green145\blue175;\red0\green0\blue255;}\f0 \fs19 \cf1 IProductRepository\cf0  repository =\par     \cf2 new\cf0  \cf1 PerformanceMeasuringProductRepository\cf0 (\par         \cf2 new\cf0  \cf1 CachingProductRepository\cf0 (\par             \cf2 new\cf0  \cf1 SqlProductRepository\cf0 (), \cf2 new\cf0  \cf1 Cache\cf0 ()\par             ),\par         \cf2 new\cf0  \cf1 RealStopwatch\cf0 ()\par     );\par \cf2 var\cf0  vm = \cf2 new\cf0  \cf1 Pr\uinput1\u233 &#233;cisViewModel\cf0 (repository);\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">IProductRepository</span> repository =</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">PerformanceMeasuringProductRepository</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">CachingProductRepository</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">SqlProductRepository</span>(), <span style="color: blue">new</span> <span style="color: #2b91af">Cache</span>()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">RealStopwatch</span>()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; );</pre><pre style="margin: 0px"><span style="color: blue">var</span> vm = <span style="color: blue">new</span> <span style="color: #2b91af">PrécisViewModel</span>(repository);</pre></div>
<p>The next time someone on your team claims that you don't need DI because the choice of RDBMS is fixed, you can tell them that it's irrelevant. The choice is between DI and Spaghetti Code.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author">Arnis L</div>
	<div class="comment-content">That was marvelous post. Never thought about this kind of approach.<br>
<br>
Btw, i never figured out if there is anything why service locator isn't anti pattern. :)</div>
	<div class="comment-date">2010-04-08 11:27 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Thanks :)<br>
<br>
I'm not sure I understand your comment regarding Service Locator. It <em>is</em> an anti-pattern :)<br>
<br>
No, seriously, I never expected the entire world to just accept my word as gospel, and there are many people who disagree on this point. Did you have something specific in mind?</div>
	<div class="comment-date">2010-04-08 11:37 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://mindinthewater.blogspot.com">wcoenen</a></div>
	<div class="comment-content">I recently listened to a short <a href="http://weblog.savanne.be/files/fosdem-mono-2010/monotorrent.odp">talk</a> by the MonoTorrent author at FOSDEM 2010. His presentation included an explanation of how (after running into maintenance hell first) he had separated the different concerns in his bittorrent <a href="http://anonsvn.mono-project.com/viewvc/trunk/bitsharp/src/MonoTorrent/MonoTorrent.Client/PiecePicking/">piece picking code</a> by implementing it as a series of decorators.<br>
<br>
For me the interesting thing about the talk was that apparently this &quot;separation of concerns&quot; thing had been an important enough discovery for him that it warranted the use of half the presentation time to explain, with the other half being spent talking about the dangers of multi-threading :-)</div>
	<div class="comment-date">2010-04-09 07:24 UTC</div>
</div><div class="comment">
	<div class="comment-author">Kshitij</div>
	<div class="comment-content">Love, the blog spot. thanks for showing DI in action.</div>
	<div class="comment-date">2010-04-19 00:01 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.clear-lines.com/blog">Mathias</a></div>
	<div class="comment-content">Totally off-topic comment, but I believe this is the first time I witness C# code with acute accents :) Do you really use accents in your code?</div>
	<div class="comment-date">2010-04-26 21:20 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk/">Mark Seemann</a></div>
	<div class="comment-content">He he, no, normally I don't, but sometimes when writing sample code I like taking advantage of the fact that C# is based on Unicode. Somewhere here, I also have a sample that uses Danish characters (&#230;, &#248; or &#229;), but I can't remember which post it was :)</div>
	<div class="comment-date">2010-04-26 21:30 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://twitter.com/samuelpearson">Sam</a></div>
	<div class="comment-content">Hey Mark,<br>
A little off-topic, but how'd you implement Cache to force evaluation if it gets passed a Func&lt;IEnumerable&lt;Something&gt;&gt;?  Else it will just cache the query.</div>
	<div class="comment-date">2010-10-08 22:17 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Yes, you are right. <em>Perhaps</em> it will just cache the query - it actually depends on what the concrete implementation is. It may be an array or List&lt;T&gt;, in which case there is no issue.<br>
<br>
However, we could always specialize the implementation of the cache so that if T was IEnumerable, we'd invoke ToList() on it before caching the result.</div>
	<div class="comment-date">2010-10-09 07:04 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://www.google.com/accounts/o8/id?id=AItOawmoyiZWGtGH4B-5d0X_KnFsJqRSqFK8p2k">www.google.com/accounts/o8/id?id=AItOawmoyiZWGtGH4B-5d0X_KnFsJqRSqFK8p2k</a></div>
	<div class="comment-content">Geat post, this shows clearly how you can chain functionality without violation OCP and SRP</div>
	<div class="comment-date">2011-04-07 08:34 UTC</div>
</div><div class="comment">
	<div class="comment-author">Tom Stickel</div>
	<div class="comment-content">Awesome as usual.  Once I drank in the Mark Seemann punch, I'm addicted to following how to do DI properly. <br>
Thanks Mark.  Any books from you scheduled for this year or the next?<br>
<br>
 </div>
	<div class="comment-date">2012-01-15 19:04 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">Thanks, Tom. No new book scheduled right now :)</div>
	<div class="comment-date">2012-01-15 19:33 UTC</div>
</div><div class="comment">
	<div class="comment-author">Alex</div>
	<div class="comment-content">Hi Mark!<br>
<br>
What if IProductRepository has 15 methods but only one method should be cached?<br>
<br>
Or what if I don't need always the cache? So I have a ProductService that needs a IProductRepository. For 5 cases the ProducrtService would need the CachingProductRepository and for the rest the standard ProductRepository?</div>
	<div class="comment-date">2012-09-12 11:46 UTC</div>
</div><div class="comment">
	<div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
	<div class="comment-content">If you have 15 methods and only one should be cached, you can still cache the one method with a Decorator. The remaining 14 methods on that Decorator can be implemented as pure delegation.<br>
<br>
However, if you have this scenario, could it be that the interface violates the Interface Segregation Principle?</div>
	<div class="comment-date">2012-09-12 11:56 UTC</div>
</div>
</div>