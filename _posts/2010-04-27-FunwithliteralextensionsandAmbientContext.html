---
layout: post
tags: [Dependency Injection, Unit Testing]
date: 2010-04-27 04:24:25 UTC
title: "Fun with literal extensions and Ambient Context"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p><a href="http://www.manning.com/seemann/">My book</a> contains a section on the <a href="http://blogs.msdn.com/ploeh/archive/2007/07/23/AmbientContext.aspx">Ambient Context</a> pattern that uses a TimeProvider as an example. It's used like this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 this\cf0 .closedAt = \cf4 TimeProvider\cf0 .Current.UtcNow;}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">this</span>.closedAt = <span style="color: #2b91af">TimeProvider</span>.Current.UtcNow;</pre></div>
<p>Yesterday I was TDDing a state machine that consumes TimeProvider and needed to freeze and advance time at different places in the test. Always on the lookout for making unit tests more readable, I decided to have a little fun with literal extensions and TimeProvider. I ended up with this test:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green128\blue0;\red255\green255\blue255;\red0\green0\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 // Fixture setup\par ??\cf3 var\cf0  fixture = \cf3 new\cf0  \cf5 WcfFixture\cf0 ();\par ??\par ??\cf5 DateTime\cf0 .Now.Freeze();\par ??\par ??fixture.Register(1.Minutes());\par ??\cf3 var\cf0  sut = fixture.CreateAnonymous&lt;\cf5 CircuitBreaker\cf0 &gt;();\par ??sut.PutInOpenState();\par ??\par ??2.Minutes().Pass();\par ??\cf1 // Exercise system\par ??\cf0 sut.Guard();\par ??\cf1 // Verify outcome\par ??\cf5 Assert\cf0 .IsInstanceOfType(sut.State,\par ??    \cf3 typeof\cf0 (\cf5 HalfOpenCircuitState\cf0 ));\par ??\cf1 // Teardown}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: green">// Fixture setup</span></pre><pre style="margin: 0px"><span style="color: blue">var</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">WcfFixture</span>();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: #2b91af">DateTime</span>.Now.Freeze();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">fixture.Register(1.Minutes());</pre><pre style="margin: 0px"><span style="color: blue">var</span> sut = fixture.CreateAnonymous&lt;<span style="color: #2b91af">CircuitBreaker</span>&gt;();</pre><pre style="margin: 0px">sut.PutInOpenState();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">2.Minutes().Pass();</pre><pre style="margin: 0px"><span style="color: green">// Exercise system</span></pre><pre style="margin: 0px">sut.Guard();</pre><pre style="margin: 0px"><span style="color: green">// Verify outcome</span></pre><pre style="margin: 0px"><span style="color: #2b91af">Assert</span>.IsInstanceOfType(sut.State,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">typeof</span>(<span style="color: #2b91af">HalfOpenCircuitState</span>));</pre><pre style="margin: 0px"><span style="color: green">// Teardown</span></pre></div>
<p>There are several items of note. Imagine that we can freeze time!</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red43\green145\blue175;\red255\green255\blue255;\red0\green0\blue0;}??\fs20 \cf1 DateTime\cf0 .Now.Freeze();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: #2b91af">DateTime</span>.Now.Freeze();</pre></div>
<p>With the TimeProvider and an extension method, we can:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 internal\cf0  \cf1 static\cf0  \cf1 void\cf0  Freeze(\cf1 this\cf0  \cf4 DateTime\cf0  dt)\par ??\{\par ??    \cf1 var\cf0  timeProviderStub = \cf1 new\cf0  \cf4 Mock\cf0 &lt;\cf4 TimeProvider\cf0 &gt;();\par ??    timeProviderStub.SetupGet(tp =&gt; tp.UtcNow).Returns(dt);\par ??    \cf4 TimeProvider\cf0 .Current = timeProviderStub.Object;\par ??\}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">void</span> Freeze(<span style="color: blue">this</span> <span style="color: #2b91af">DateTime</span> dt)</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> timeProviderStub = <span style="color: blue">new</span> <span style="color: #2b91af">Mock</span>&lt;<span style="color: #2b91af">TimeProvider</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; timeProviderStub.SetupGet(tp =&gt; tp.UtcNow).Returns(dt);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">TimeProvider</span>.Current = timeProviderStub.Object;</pre><pre style="margin: 0px">}</pre></div>
<p>This effectively sets up the TimeProvider to always return the same time.</p>
<p>Later in the test I state that 2 minutes pass:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;}??\fs20 2.Minutes().Pass();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">2.Minutes().Pass();</pre></div>
<p>I particularly like the grammatically correct English. This is accomplished with a combination of a literal extension and changing the state of TimeProvider.</p>
<p>First, the literal extension:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 internal\cf0  \cf1 static\cf0  \cf4 TimeSpan\cf0  Minutes(\cf1 this\cf0  \cf1 int\cf0  m)\par ??\{\par ??    \cf1 return\cf0  \cf4 TimeSpan\cf0 .FromMinutes(m);\par ??\}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: #2b91af">TimeSpan</span> Minutes(<span style="color: blue">this</span> <span style="color: blue">int</span> m)</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: #2b91af">TimeSpan</span>.FromMinutes(m);</pre><pre style="margin: 0px">}</pre></div>
<p>Given the TimeSpan returned from the Minutes method, I can now invoke the Pass extension method:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 internal\cf0  \cf1 static\cf0  \cf1 void\cf0  Pass(\cf1 this\cf0  \cf4 TimeSpan\cf0  ts)\par ??\{\par ??    \cf1 var\cf0  previousTime = \cf4 TimeProvider\cf0 .Current.UtcNow;\par ??    (previousTime + ts).Freeze();\par ??\}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">internal</span> <span style="color: blue">static</span> <span style="color: blue">void</span> Pass(<span style="color: blue">this</span> <span style="color: #2b91af">TimeSpan</span> ts)</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> previousTime = <span style="color: #2b91af">TimeProvider</span>.Current.UtcNow;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; (previousTime + ts).Freeze();</pre><pre style="margin: 0px">}</pre></div>
<p>Note that I just add the TimeSpan to the current time and invoke the Freeze extension method with the new value.</p>
<p>Last, but not least, I should point out that the PutInOpenState method isn't some smelly test-specific method on the <a href="http://xunitpatterns.com/SUT.html">SUT</a>, but rather yet another extension method.</p>
</div>
	