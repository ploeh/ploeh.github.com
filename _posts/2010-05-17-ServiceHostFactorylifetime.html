---
layout: post
tags: [Dependency Injection, Services]
date: 2010-05-17 05:42:33 UTC
title: "ServiceHostFactory lifetime"
comments: true
---
{% include JB/setup %}

<div id="post">
	<p>For a while I've been wondering about the lifetime behavior of custom <a href="http://msdn.microsoft.com/en-us/library/system.servicemodel.activation.servicehostfactory.aspx">ServiceHostFactory</a> classes hosted in IIS. Does IIS create an instance per request? Or a single instance to handle all requests?</p> <p>I decided to find out, so I wrote a little test service. The conclusion seems to be that there is only a single instance that servers as a factory for all requests. This is very fortunate, since it gives us an excellent place to host a DI Container. The container can then manage the lifetime of all components, including Singletons that will live for the duration of the process.</p> <p>If you are curious how I arrived at this conclusion, here's the code I wrote. I started out with this custom ServiceHostFactory:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 PocServiceHostFactory\cf0  : \cf2 ServiceHostFactory\cf0 \par \{\par     \cf1 private\cf0  \cf1 static\cf0  \cf1 int\cf0  number = 1;\par \par     \cf1 public\cf0  PocServiceHostFactory()\par     \{\par         \cf2 Interlocked\cf0 .Increment(\par             \cf1 ref\cf0  \cf2 PocServiceHostFactory\cf0 .number);\par     \}\par \par     \cf1 protected\cf0  \cf1 override\cf0  \cf2 ServiceHost\cf0  CreateServiceHost(\par         \cf2 Type\cf0  serviceType, \cf2 Uri\cf0 [] baseAddresses)\par     \{\par         \cf1 return\cf0  \cf1 new\cf0  \cf2 PocServiceHost\cf0 (\par             \cf2 PocServiceHostFactory\cf0 .number, serviceType,\par             baseAddresses);\par     \}\par \}\par }
--> <div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PocServiceHostFactory</span> : <span style="color: #2b91af">ServiceHostFactory</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">int</span> number = 1;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> PocServiceHostFactory()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Interlocked</span>.Increment(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">ref</span> <span style="color: #2b91af">PocServiceHostFactory</span>.number);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">ServiceHost</span> CreateServiceHost(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Type</span> serviceType, <span style="color: #2b91af">Uri</span>[] baseAddresses)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">PocServiceHost</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">PocServiceHostFactory</span>.number, serviceType,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; baseAddresses);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre></div>
<p>The idea is that every time a new instance of ServiceHostFactory is created, the static number is incremented.</p>
<p>The PocServiceHostFactory just forwards the number to the PocServiceHost:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 PocServiceHost\cf0  : \cf2 ServiceHost\cf0 \par \{\par     \cf1 public\cf0  PocServiceHost(\cf1 int\cf0  number, \cf2 Type\cf0  serviceType,\par         \cf2 Uri\cf0 [] baseAddresses)\par         : \cf1 base\cf0 (serviceType, baseAddresses)\par     \{\par         \cf1 foreach\cf0  (\cf1 var\cf0  cd \cf1 in\cf0  \par             \cf1 this\cf0 .ImplementedContracts.Values)\par         \{\par             cd.Behaviors.Add(\par                 \cf1 new\cf0  \cf2 NumberServiceInstanceProvider\cf0 (\par                     number));\par         \}\par     \}\par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">PocServiceHost</span> : <span style="color: #2b91af">ServiceHost</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> PocServiceHost(<span style="color: blue">int</span> number, <span style="color: #2b91af">Type</span> serviceType,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Uri</span>[] baseAddresses)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : <span style="color: blue">base</span>(serviceType, baseAddresses)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: blue">var</span> cd <span style="color: blue">in</span> </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.ImplementedContracts.Values)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cd.Behaviors.Add(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">NumberServiceInstanceProvider</span>(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; number));</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">}</pre></div>
<p>The PocServiceHost just forwards the number to the NumberServiceInstanceProvider:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 NumberServiceInstanceProvider\cf0  : \par     \cf2 IInstanceProvider\cf0 , \cf2 IContractBehavior\cf0 \par \{\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf1 int\cf0  number;\par \par     \cf1 public\cf0  NumberServiceInstanceProvider(\cf1 int\cf0  number)\par     \{\par         \cf1 this\cf0 .number = number;\par     \}\par \par \cf1     #region\cf0  IInstanceProvider Members\par \par     \cf1 public\cf0  \cf1 object\cf0  GetInstance(\par         \cf2 InstanceContext\cf0  instanceContext,\par         \cf2 Message\cf0  message)\par     \{\par         \cf1 return\cf0  \cf1 this\cf0 .GetInstance(instanceContext);\par     \}\par \par     \cf1 public\cf0  \cf1 object\cf0  GetInstance(\par         \cf2 InstanceContext\cf0  instanceContext)\par     \{\par         \cf1 return\cf0  \cf1 new\cf0  \cf2 NumberService\cf0 (\cf1 this\cf0 .number);\par     \}\par \par     \cf1 public\cf0  \cf1 void\cf0  ReleaseInstance(\par         \cf2 InstanceContext\cf0  instanceContext,\par         \cf1 object\cf0  instance)\par     \{\par     \}\par \par \cf1     #endregion\cf0 \par \par \cf1     #region\cf0  IContractBehavior Members\par \par     \cf1 public\cf0  \cf1 void\cf0  AddBindingParameters(\par         \cf2 ContractDescription\cf0  contractDescription,\par         \cf2 ServiceEndpoint\cf0  endpoint,\par         \cf2 BindingParameterCollection\cf0  bindingParameters)\par     \{\par     \}\par \par     \cf1 public\cf0  \cf1 void\cf0  ApplyClientBehavior(\par         \cf2 ContractDescription\cf0  contractDescription,\par         \cf2 ServiceEndpoint\cf0  endpoint,\par         \cf2 ClientRuntime\cf0  clientRuntime)\par     \{\par     \}\par \par     \cf1 public\cf0  \cf1 void\cf0  ApplyDispatchBehavior(\par         \cf2 ContractDescription\cf0  contractDescription,\par         \cf2 ServiceEndpoint\cf0  endpoint,\par         \cf2 DispatchRuntime\cf0  dispatchRuntime)\par     \{\par         dispatchRuntime.InstanceProvider = \cf1 this\cf0 ;\par     \}\par \par     \cf1 public\cf0  \cf1 void\cf0  Validate(\par         \cf2 ContractDescription\cf0  contractDescription,\par         \cf2 ServiceEndpoint\cf0  endpoint)\par     \{\par     \}\par \par \cf1     #endregion\cf0 \par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">NumberServiceInstanceProvider</span> : </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IInstanceProvider</span>, <span style="color: #2b91af">IContractBehavior</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: blue">int</span> number;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> NumberServiceInstanceProvider(<span style="color: blue">int</span> number)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.number = number;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IInstanceProvider Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">object</span> GetInstance(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">InstanceContext</span> instanceContext,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Message</span> message)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">this</span>.GetInstance(instanceContext);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">object</span> GetInstance(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">InstanceContext</span> instanceContext)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">NumberService</span>(<span style="color: blue">this</span>.number);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> ReleaseInstance(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">InstanceContext</span> instanceContext,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">object</span> instance)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> IContractBehavior Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> AddBindingParameters(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ContractDescription</span> contractDescription,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ServiceEndpoint</span> endpoint,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">BindingParameterCollection</span> bindingParameters)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> ApplyClientBehavior(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ContractDescription</span> contractDescription,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ServiceEndpoint</span> endpoint,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ClientRuntime</span> clientRuntime)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> ApplyDispatchBehavior(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ContractDescription</span> contractDescription,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ServiceEndpoint</span> endpoint,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">DispatchRuntime</span> dispatchRuntime)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dispatchRuntime.InstanceProvider = <span style="color: blue">this</span>;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Validate(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ContractDescription</span> contractDescription,</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ServiceEndpoint</span> endpoint)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>The relevant part of NumberServiceInstanceProvider is the GetInstanceMethod that simply forwards the number to the NumberService:</p><!--
{\rtf\ansi{\fonttbl{\f0 Consolas;}}{\colortbl;\red0\green0\blue255;\red43\green145\blue175;}\f0 \fs19 \cf1 public\cf0  \cf1 class\cf0  \cf2 NumberService\cf0  : \cf2 INumberService\cf0 \par \{\par     \cf1 private\cf0  \cf1 readonly\cf0  \cf1 int\cf0  number;\par \par     \cf1 public\cf0  NumberService(\cf1 int\cf0  number)\par     \{\par         \cf1 this\cf0 .number = number;\par     \}\par \par \cf1     #region\cf0  INumberService Members\par \par     \cf1 public\cf0  \cf1 int\cf0  GetNumber()\par     \{\par         \cf1 return\cf0  \cf1 this\cf0 .number;\par     \}\par \par \cf1     #endregion\cf0 \par \}\par }
-->
<div style="font-family: consolas; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">NumberService</span> : <span style="color: #2b91af">INumberService</span></pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: blue">int</span> number;</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> NumberService(<span style="color: blue">int</span> number)</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.number = number;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #region</span> INumberService Members</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">int</span> GetNumber()</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: blue">this</span>.number;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; #endregion</span></pre><pre style="margin: 0px">}</pre></div>
<p>As you can see, NumberService simply returns the injected number.</p>
<p>The experiment is now to host NumberService in IIS using PocServiceHostFactory. If there is only one ServiceHostFactory per application process, we would expect that the same number (2) is returned every time we invoke the GetNumber operation. If, on the other hand, a new instance of ServiceHostFactory is created per request, we would expect the number to increase for every request.</p>
<p>To test this I spun up a few instances of WcfTestClient.exe and invoked the operation. It consistently returns <em>2</em> across multiple clients and multiple requests. This supports the hypothesis that there is only one ServiceHostFactory per service process.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author">onof</div>
	<div class="comment-content">There's a project on codeplex<br>
<br>
http://containerservicehost.codeplex.com/documentation<br>
</div>
	<div class="comment-date">2010-05-17 07:10 UTC</div>
</div>
</div>