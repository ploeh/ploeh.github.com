---
layout: post
tags: [AutoFixture, Unit Testing]
date: 2010-04-06 05:22:32 UTC
title: "Mapping types with AutoFixture"
---
{% include JB/setup %}

<div id="post">
	<p>In my <a href="http://blog.ploeh.dk/2010/03/27/FreezingMocks.aspx">previous</a> <a href="http://blog.ploeh.dk/2010/03/26/MoreAboutFrozenPizza.aspx">posts</a> I demonstrated interaction-based unit tests that verify that a pizza is correctly being added to a shopping basket. An alternative is a state-based test where we examine the contents of the shopping basket after exercising the <a href="http://xunitpatterns.com/SUT.html">SUT</a>. Here's an initial attempt:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red43\green145\blue175;\red0\green0\blue255;\red0\green128\blue0;\red163\green21\blue21;}??\fs20 [\cf3 TestMethod\cf0 ]\par ??\cf4 public\cf0  \cf4 void\cf0  AddWillAddToBasket()\par ??\{\par ??    \cf5 // Fixture setup\par ??\cf0     \cf4 var\cf0  fixture = \cf4 new\cf0  \cf3 Fixture\cf0 ();\par ??    fixture.Register&lt;\cf3 IPizzaMap\cf0 &gt;(\par ??        fixture.CreateAnonymous&lt;\cf3 PizzaMap\cf0 &gt;);\par ??\par ??    \cf4 var\cf0  basket = fixture.Freeze&lt;\cf3 Basket\cf0 &gt;();\par ??\par ??    \cf4 var\cf0  pizza = fixture.CreateAnonymous&lt;\cf3 PizzaPresenter\cf0 &gt;();\par ??\par ??    \cf4 var\cf0  sut = fixture.CreateAnonymous&lt;\cf3 BasketPresenter\cf0 &gt;();\par ??    \cf5 // Exercise system\par ??\cf0     sut.Add(pizza);\par ??    \cf5 // Verify outcome\par ??\cf0     \cf3 Assert\cf0 .IsTrue(basket.Pizze.Any(p =&gt; \par ??        p.Name == pizza.Name), \cf6 "Basket has added pizza."\cf0 );\par ??    \cf5 // Teardown\par ??\cf0 \}}
--> <div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">[<span style="color: #2b91af">TestMethod</span>]</pre><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> AddWillAddToBasket()</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Fixture setup</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> fixture = <span style="color: blue">new</span> <span style="color: #2b91af">Fixture</span>();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; fixture.Register&lt;<span style="color: #2b91af">IPizzaMap</span>&gt;(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;<span style="color: #2b91af">PizzaMap</span>&gt;);</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> basket = fixture.Freeze&lt;<span style="color: #2b91af">Basket</span>&gt;();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> pizza = fixture.CreateAnonymous&lt;<span style="color: #2b91af">PizzaPresenter</span>&gt;();</pre><pre style="margin: 0px">&nbsp;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> sut = fixture.CreateAnonymous&lt;<span style="color: #2b91af">BasketPresenter</span>&gt;();</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Exercise system</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; sut.Add(pizza);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Verify outcome</span></pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.IsTrue(basket.Pizze.Any(p =&gt; </pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.Name == pizza.Name), <span style="color: #a31515">"Basket has added pizza."</span>);</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Teardown</span></pre><pre style="margin: 0px">}</pre></div>
<p>In this case the assertion examines the Pizze collection (you did know that the plural of <em>pizza</em> is <em>pizze</em>, right?) of the <a href="http://blog.ploeh.dk/2010/03/17/AutoFixtureFreeze.aspx">frozen Basket</a> to verify that it contains the added pizza.</p>
<p>The tricky part is that the Pizze property is a collection of Pizza instances, and not PizzaPresenter instances. The injected IPizzaMap instance is responsible for mapping from PizzaPresenter to Pizza, but since we are rewriting this as a state-based test, I thought it would also be interesting to write the test without using <a href="http://code.google.com/p/moq/">Moq</a>. Instead, we can use the real implementation of IPizzaMap, but this means that we must instruct <a href="http://autofixture.codeplex.com/">AutoFixture</a> to map from the abstract IPizzaMap to the concrete PizzaMap.</p>
<p>We see that happening in this line of code:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red43\green145\blue175;}??\fs20 fixture.Register&lt;\cf3 IPizzaMap\cf0 &gt;(\par ??    fixture.CreateAnonymous&lt;\cf3 PizzaMap\cf0 &gt;);}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">fixture.Register&lt;<span style="color: #2b91af">IPizzaMap</span>&gt;(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;<span style="color: #2b91af">PizzaMap</span>&gt;);</pre></div>
<p>Notice the method group syntax: we pass in a delegate to the CreateAnonymous method, which means that every time the fixture is asked to create an IPizzaMap instance, it invokes CreateAnonymous&lt;PIzzaMap&gt;() and uses the result.</p>
<p>This is, obviously, a general-purpose way in which we can map compatible types, so we can write an extension method like this one:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue255;\red255\green255\blue255;\red0\green0\blue0;\red43\green145\blue175;}??\fs20 \cf1 public\cf0  \cf1 static\cf0  \cf1 void\cf0  Register&lt;TAbstract, TConcrete&gt;(\par ??    \cf1 this\cf0  \cf4 Fixture\cf0  fixture) \cf1 where\cf0  TConcrete : TAbstract\par ??\{\par ??    fixture.Register&lt;TAbstract&gt;(() =&gt;\par ??        fixture.CreateAnonymous&lt;TConcrete&gt;());\par ??\}}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> Register&lt;TAbstract, TConcrete&gt;(</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span> <span style="color: #2b91af">Fixture</span> fixture) <span style="color: blue">where</span> TConcrete : TAbstract</pre><pre style="margin: 0px">{</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp; fixture.Register&lt;TAbstract&gt;(() =&gt;</pre><pre style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;TConcrete&gt;());</pre><pre style="margin: 0px">}</pre></div>
<p>(I'm slightly undecided on the name of this method. <em>Map</em> might be a better name, but I just like the equivalence to some common DI Containers and their Register methods.) Armed with this Register overload, we can now rewrite the previous Register statement like this:</p><!--
{\rtf1\ansi\ansicpg\lang1024\noproof65001\uc1 \deff0{\fonttbl{\f0\fnil\fcharset0\fprq1 Courier New;}}{\colortbl;??\red0\green0\blue0;\red255\green255\blue255;\red43\green145\blue175;}??\fs20 fixture.Register&lt;\cf3 IPizzaMap\cf0 , \cf3 PizzaMap\cf0 &gt;();}
-->
<div style="font-family: courier new; background: white; color: black; font-size: 10pt"><pre style="margin: 0px">fixture.Register&lt;<span style="color: #2b91af">IPizzaMap</span>, <span style="color: #2b91af">PizzaMap</span>&gt;();</pre></div>
<p>It's the same amount of code lines, but I find it slightly more succinct and communicative.</p>
<p>The real point of this blog post, however, is that you can map abstract types to concrete types, and that you can always write extension methods to encapsulate your own AutoFixture idioms.</p>
</div>
	
<div id="comments">
<hr>
<h2 id="comments-header">
	Comments
</h2>
	<div class="comment">
	<div class="comment-author"><a href="http://nikosbaxevanis.com/">Nikos Baxevanis</a></div>
	<div class="comment-content">I also prefer Register (instead of Map). Because most of the times it will be like that: registering an interface to an implementation.</div>
	<div class="comment-date">2011-03-13 10:06 UTC</div>
</div>
</div>